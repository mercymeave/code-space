"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _JwtGenerator = _interopRequireDefault(require("./JwtGenerator"));

var _HashGenerator = _interopRequireDefault(require("./HashGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Right now only key/secret credentials are supported.
 * However, in time JWT will also be supported.
 * The `Credentials` object provides an abstraction to this.
 *
 * @param {string} apiKey - A Nexmo API Key
 * @param {string} apiSecret - A Nexmo API Secret
 * @param {string} [applicationId] - A Nexmo Application ID
 * @param {string|Buffer} [privateKey] -  When a string value is passed it should
 *                        either represent the path to the private key, or the actual
 *                        private key in string format. If a Buffer is passed then
 *                        it should be the key read from the file system.
 * @param {string} [signatureSecret] - A Nexmo signature Secret
 * @param {string} [signatureMethod] - A Nexmo compatible request signing method
 */
class Credentials {
  constructor(apiKey, apiSecret, privateKey, applicationId, signatureSecret, signatureMethod) {
    this.apiKey = apiKey;
    this.apiSecret = apiSecret;
    this.privateKey = null;
    this.applicationId = applicationId;
    this.signatureSecret = signatureSecret;
    this.signatureMethod = signatureMethod;

    if (privateKey instanceof Buffer) {
      // it is already a buffer, use it as-is
      this.privateKey = privateKey;
    } else if (typeof privateKey === "string" && privateKey.startsWith("-----BEGIN PRIVATE KEY-----")) {
      // It's a key string. Check for \n, replace with newlines
      privateKey = privateKey.replace(/\\n/g, "\n");
      this.privateKey = Buffer.from(privateKey, "utf-8");
    } else if (privateKey !== undefined) {
      if (!_fs.default.existsSync(privateKey)) {
        throw new Error("File \"".concat(privateKey, "\" not found."));
      }

      this.privateKey = _fs.default.readFileSync(privateKey);
    }
    /** @private */


    this._jwtGenerator = new _JwtGenerator.default();
    this._hashGenerator = new _HashGenerator.default();
  }
  /**
   * Generate a Jwt using the Private Key in the Credentials.
   * By default the credentials.applicationId will be used when creating the token.
   * However, this can be overwritten.
   *
   * @param {string} [applicationId] an application ID to be used instead of the
   *                default Credentials.applicationId value.
   *
   * @returns {string} The generated JWT
   */


  generateJwt() {
    var applicationId = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : this.applicationId;
    var privateKey = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.privateKey;
    var claims = {
      application_id: applicationId
    };

    var token = this._jwtGenerator.generate(privateKey, claims);

    return token;
  }

  generateSignature(params) {
    var signatureSecret = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.signatureSecret;
    var signatureMethod = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : this.signatureMethod;
    return this._hashGenerator.generate(signatureMethod, signatureSecret, params);
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setJwtGenerator(generator) {
    this._jwtGenerator = generator;
  }
  /**
   * @private
   * Used for testing purposes only.
   */


  _setHashGenerator(generator) {
    this._hashGenerator = generator;
  }
  /**
   * Ensures a credentials instance is used.
   *
   * Key/Secret credentials are only supported at present.
   */


  static parse(obj) {
    if (obj instanceof Credentials) {
      return obj;
    } else {
      return new Credentials(obj.apiKey, obj.apiSecret, obj.privateKey, obj.applicationId, obj.signatureSecret, obj.signatureMethod);
    }
  }

}

var _default = Credentials;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9DcmVkZW50aWFscy5qcyJdLCJuYW1lcyI6WyJDcmVkZW50aWFscyIsImNvbnN0cnVjdG9yIiwiYXBpS2V5IiwiYXBpU2VjcmV0IiwicHJpdmF0ZUtleSIsImFwcGxpY2F0aW9uSWQiLCJzaWduYXR1cmVTZWNyZXQiLCJzaWduYXR1cmVNZXRob2QiLCJCdWZmZXIiLCJzdGFydHNXaXRoIiwicmVwbGFjZSIsImZyb20iLCJ1bmRlZmluZWQiLCJmcyIsImV4aXN0c1N5bmMiLCJFcnJvciIsInJlYWRGaWxlU3luYyIsIl9qd3RHZW5lcmF0b3IiLCJKd3RHZW5lcmF0b3IiLCJfaGFzaEdlbmVyYXRvciIsIkhhc2hHZW5lcmF0b3IiLCJnZW5lcmF0ZUp3dCIsImNsYWltcyIsImFwcGxpY2F0aW9uX2lkIiwidG9rZW4iLCJnZW5lcmF0ZSIsImdlbmVyYXRlU2lnbmF0dXJlIiwicGFyYW1zIiwiX3NldEp3dEdlbmVyYXRvciIsImdlbmVyYXRvciIsIl9zZXRIYXNoR2VuZXJhdG9yIiwicGFyc2UiLCJvYmoiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7Ozs7QUFFQTs7Ozs7Ozs7Ozs7Ozs7O0FBZUEsTUFBTUEsV0FBTixDQUFrQjtBQUNoQkMsRUFBQUEsV0FBVyxDQUNUQyxNQURTLEVBRVRDLFNBRlMsRUFHVEMsVUFIUyxFQUlUQyxhQUpTLEVBS1RDLGVBTFMsRUFNVEMsZUFOUyxFQU9UO0FBQ0EsU0FBS0wsTUFBTCxHQUFjQSxNQUFkO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFFQSxTQUFLQyxVQUFMLEdBQWtCLElBQWxCO0FBQ0EsU0FBS0MsYUFBTCxHQUFxQkEsYUFBckI7QUFFQSxTQUFLQyxlQUFMLEdBQXVCQSxlQUF2QjtBQUNBLFNBQUtDLGVBQUwsR0FBdUJBLGVBQXZCOztBQUVBLFFBQUlILFVBQVUsWUFBWUksTUFBMUIsRUFBa0M7QUFDaEM7QUFDQSxXQUFLSixVQUFMLEdBQWtCQSxVQUFsQjtBQUNELEtBSEQsTUFHTyxJQUNMLE9BQU9BLFVBQVAsS0FBc0IsUUFBdEIsSUFDQUEsVUFBVSxDQUFDSyxVQUFYLENBQXNCLDZCQUF0QixDQUZLLEVBR0w7QUFDQTtBQUNBTCxNQUFBQSxVQUFVLEdBQUdBLFVBQVUsQ0FBQ00sT0FBWCxDQUFtQixNQUFuQixFQUEyQixJQUEzQixDQUFiO0FBQ0EsV0FBS04sVUFBTCxHQUFrQkksTUFBTSxDQUFDRyxJQUFQLENBQVlQLFVBQVosRUFBd0IsT0FBeEIsQ0FBbEI7QUFDRCxLQVBNLE1BT0EsSUFBSUEsVUFBVSxLQUFLUSxTQUFuQixFQUE4QjtBQUNuQyxVQUFJLENBQUNDLFlBQUdDLFVBQUgsQ0FBY1YsVUFBZCxDQUFMLEVBQWdDO0FBQzlCLGNBQU0sSUFBSVcsS0FBSixrQkFBbUJYLFVBQW5CLG1CQUFOO0FBQ0Q7O0FBQ0QsV0FBS0EsVUFBTCxHQUFrQlMsWUFBR0csWUFBSCxDQUFnQlosVUFBaEIsQ0FBbEI7QUFDRDtBQUVEOzs7QUFDQSxTQUFLYSxhQUFMLEdBQXFCLElBQUlDLHFCQUFKLEVBQXJCO0FBQ0EsU0FBS0MsY0FBTCxHQUFzQixJQUFJQyxzQkFBSixFQUF0QjtBQUNEO0FBRUQ7Ozs7Ozs7Ozs7OztBQVVBQyxFQUFBQSxXQUFXLEdBR1Q7QUFBQSxRQUZBaEIsYUFFQSx1RUFGZ0IsS0FBS0EsYUFFckI7QUFBQSxRQURBRCxVQUNBLHVFQURhLEtBQUtBLFVBQ2xCO0FBQ0EsUUFBSWtCLE1BQU0sR0FBRztBQUNYQyxNQUFBQSxjQUFjLEVBQUVsQjtBQURMLEtBQWI7O0FBR0EsUUFBSW1CLEtBQUssR0FBRyxLQUFLUCxhQUFMLENBQW1CUSxRQUFuQixDQUE0QnJCLFVBQTVCLEVBQXdDa0IsTUFBeEMsQ0FBWjs7QUFDQSxXQUFPRSxLQUFQO0FBQ0Q7O0FBRURFLEVBQUFBLGlCQUFpQixDQUNmQyxNQURlLEVBSWY7QUFBQSxRQUZBckIsZUFFQSx1RUFGa0IsS0FBS0EsZUFFdkI7QUFBQSxRQURBQyxlQUNBLHVFQURrQixLQUFLQSxlQUN2QjtBQUNBLFdBQU8sS0FBS1ksY0FBTCxDQUFvQk0sUUFBcEIsQ0FDTGxCLGVBREssRUFFTEQsZUFGSyxFQUdMcUIsTUFISyxDQUFQO0FBS0Q7QUFFRDs7Ozs7O0FBSUFDLEVBQUFBLGdCQUFnQixDQUFDQyxTQUFELEVBQVk7QUFDMUIsU0FBS1osYUFBTCxHQUFxQlksU0FBckI7QUFDRDtBQUVEOzs7Ozs7QUFJQUMsRUFBQUEsaUJBQWlCLENBQUNELFNBQUQsRUFBWTtBQUMzQixTQUFLVixjQUFMLEdBQXNCVSxTQUF0QjtBQUNEO0FBRUQ7Ozs7Ozs7QUFLQSxTQUFPRSxLQUFQLENBQWFDLEdBQWIsRUFBa0I7QUFDaEIsUUFBSUEsR0FBRyxZQUFZaEMsV0FBbkIsRUFBZ0M7QUFDOUIsYUFBT2dDLEdBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxhQUFPLElBQUloQyxXQUFKLENBQ0xnQyxHQUFHLENBQUM5QixNQURDLEVBRUw4QixHQUFHLENBQUM3QixTQUZDLEVBR0w2QixHQUFHLENBQUM1QixVQUhDLEVBSUw0QixHQUFHLENBQUMzQixhQUpDLEVBS0wyQixHQUFHLENBQUMxQixlQUxDLEVBTUwwQixHQUFHLENBQUN6QixlQU5DLENBQVA7QUFRRDtBQUNGOztBQTNHZTs7ZUE4R0hQLFciLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IGZzIGZyb20gXCJmc1wiO1xuaW1wb3J0IEp3dEdlbmVyYXRvciBmcm9tIFwiLi9Kd3RHZW5lcmF0b3JcIjtcbmltcG9ydCBIYXNoR2VuZXJhdG9yIGZyb20gXCIuL0hhc2hHZW5lcmF0b3JcIjtcblxuLyoqXG4gKiBSaWdodCBub3cgb25seSBrZXkvc2VjcmV0IGNyZWRlbnRpYWxzIGFyZSBzdXBwb3J0ZWQuXG4gKiBIb3dldmVyLCBpbiB0aW1lIEpXVCB3aWxsIGFsc28gYmUgc3VwcG9ydGVkLlxuICogVGhlIGBDcmVkZW50aWFsc2Agb2JqZWN0IHByb3ZpZGVzIGFuIGFic3RyYWN0aW9uIHRvIHRoaXMuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwaUtleSAtIEEgTmV4bW8gQVBJIEtleVxuICogQHBhcmFtIHtzdHJpbmd9IGFwaVNlY3JldCAtIEEgTmV4bW8gQVBJIFNlY3JldFxuICogQHBhcmFtIHtzdHJpbmd9IFthcHBsaWNhdGlvbklkXSAtIEEgTmV4bW8gQXBwbGljYXRpb24gSURcbiAqIEBwYXJhbSB7c3RyaW5nfEJ1ZmZlcn0gW3ByaXZhdGVLZXldIC0gIFdoZW4gYSBzdHJpbmcgdmFsdWUgaXMgcGFzc2VkIGl0IHNob3VsZFxuICogICAgICAgICAgICAgICAgICAgICAgICBlaXRoZXIgcmVwcmVzZW50IHRoZSBwYXRoIHRvIHRoZSBwcml2YXRlIGtleSwgb3IgdGhlIGFjdHVhbFxuICogICAgICAgICAgICAgICAgICAgICAgICBwcml2YXRlIGtleSBpbiBzdHJpbmcgZm9ybWF0LiBJZiBhIEJ1ZmZlciBpcyBwYXNzZWQgdGhlblxuICogICAgICAgICAgICAgICAgICAgICAgICBpdCBzaG91bGQgYmUgdGhlIGtleSByZWFkIGZyb20gdGhlIGZpbGUgc3lzdGVtLlxuICogQHBhcmFtIHtzdHJpbmd9IFtzaWduYXR1cmVTZWNyZXRdIC0gQSBOZXhtbyBzaWduYXR1cmUgU2VjcmV0XG4gKiBAcGFyYW0ge3N0cmluZ30gW3NpZ25hdHVyZU1ldGhvZF0gLSBBIE5leG1vIGNvbXBhdGlibGUgcmVxdWVzdCBzaWduaW5nIG1ldGhvZFxuICovXG5jbGFzcyBDcmVkZW50aWFscyB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIGFwaUtleSxcbiAgICBhcGlTZWNyZXQsXG4gICAgcHJpdmF0ZUtleSxcbiAgICBhcHBsaWNhdGlvbklkLFxuICAgIHNpZ25hdHVyZVNlY3JldCxcbiAgICBzaWduYXR1cmVNZXRob2RcbiAgKSB7XG4gICAgdGhpcy5hcGlLZXkgPSBhcGlLZXk7XG4gICAgdGhpcy5hcGlTZWNyZXQgPSBhcGlTZWNyZXQ7XG5cbiAgICB0aGlzLnByaXZhdGVLZXkgPSBudWxsO1xuICAgIHRoaXMuYXBwbGljYXRpb25JZCA9IGFwcGxpY2F0aW9uSWQ7XG5cbiAgICB0aGlzLnNpZ25hdHVyZVNlY3JldCA9IHNpZ25hdHVyZVNlY3JldDtcbiAgICB0aGlzLnNpZ25hdHVyZU1ldGhvZCA9IHNpZ25hdHVyZU1ldGhvZDtcblxuICAgIGlmIChwcml2YXRlS2V5IGluc3RhbmNlb2YgQnVmZmVyKSB7XG4gICAgICAvLyBpdCBpcyBhbHJlYWR5IGEgYnVmZmVyLCB1c2UgaXQgYXMtaXNcbiAgICAgIHRoaXMucHJpdmF0ZUtleSA9IHByaXZhdGVLZXk7XG4gICAgfSBlbHNlIGlmIChcbiAgICAgIHR5cGVvZiBwcml2YXRlS2V5ID09PSBcInN0cmluZ1wiICYmXG4gICAgICBwcml2YXRlS2V5LnN0YXJ0c1dpdGgoXCItLS0tLUJFR0lOIFBSSVZBVEUgS0VZLS0tLS1cIilcbiAgICApIHtcbiAgICAgIC8vIEl0J3MgYSBrZXkgc3RyaW5nLiBDaGVjayBmb3IgXFxuLCByZXBsYWNlIHdpdGggbmV3bGluZXNcbiAgICAgIHByaXZhdGVLZXkgPSBwcml2YXRlS2V5LnJlcGxhY2UoL1xcXFxuL2csIFwiXFxuXCIpO1xuICAgICAgdGhpcy5wcml2YXRlS2V5ID0gQnVmZmVyLmZyb20ocHJpdmF0ZUtleSwgXCJ1dGYtOFwiKTtcbiAgICB9IGVsc2UgaWYgKHByaXZhdGVLZXkgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHByaXZhdGVLZXkpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmlsZSBcIiR7cHJpdmF0ZUtleX1cIiBub3QgZm91bmQuYCk7XG4gICAgICB9XG4gICAgICB0aGlzLnByaXZhdGVLZXkgPSBmcy5yZWFkRmlsZVN5bmMocHJpdmF0ZUtleSk7XG4gICAgfVxuXG4gICAgLyoqIEBwcml2YXRlICovXG4gICAgdGhpcy5fand0R2VuZXJhdG9yID0gbmV3IEp3dEdlbmVyYXRvcigpO1xuICAgIHRoaXMuX2hhc2hHZW5lcmF0b3IgPSBuZXcgSGFzaEdlbmVyYXRvcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIGEgSnd0IHVzaW5nIHRoZSBQcml2YXRlIEtleSBpbiB0aGUgQ3JlZGVudGlhbHMuXG4gICAqIEJ5IGRlZmF1bHQgdGhlIGNyZWRlbnRpYWxzLmFwcGxpY2F0aW9uSWQgd2lsbCBiZSB1c2VkIHdoZW4gY3JlYXRpbmcgdGhlIHRva2VuLlxuICAgKiBIb3dldmVyLCB0aGlzIGNhbiBiZSBvdmVyd3JpdHRlbi5cbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IFthcHBsaWNhdGlvbklkXSBhbiBhcHBsaWNhdGlvbiBJRCB0byBiZSB1c2VkIGluc3RlYWQgb2YgdGhlXG4gICAqICAgICAgICAgICAgICAgIGRlZmF1bHQgQ3JlZGVudGlhbHMuYXBwbGljYXRpb25JZCB2YWx1ZS5cbiAgICpcbiAgICogQHJldHVybnMge3N0cmluZ30gVGhlIGdlbmVyYXRlZCBKV1RcbiAgICovXG4gIGdlbmVyYXRlSnd0KFxuICAgIGFwcGxpY2F0aW9uSWQgPSB0aGlzLmFwcGxpY2F0aW9uSWQsXG4gICAgcHJpdmF0ZUtleSA9IHRoaXMucHJpdmF0ZUtleVxuICApIHtcbiAgICB2YXIgY2xhaW1zID0ge1xuICAgICAgYXBwbGljYXRpb25faWQ6IGFwcGxpY2F0aW9uSWRcbiAgICB9O1xuICAgIHZhciB0b2tlbiA9IHRoaXMuX2p3dEdlbmVyYXRvci5nZW5lcmF0ZShwcml2YXRlS2V5LCBjbGFpbXMpO1xuICAgIHJldHVybiB0b2tlbjtcbiAgfVxuXG4gIGdlbmVyYXRlU2lnbmF0dXJlKFxuICAgIHBhcmFtcyxcbiAgICBzaWduYXR1cmVTZWNyZXQgPSB0aGlzLnNpZ25hdHVyZVNlY3JldCxcbiAgICBzaWduYXR1cmVNZXRob2QgPSB0aGlzLnNpZ25hdHVyZU1ldGhvZFxuICApIHtcbiAgICByZXR1cm4gdGhpcy5faGFzaEdlbmVyYXRvci5nZW5lcmF0ZShcbiAgICAgIHNpZ25hdHVyZU1ldGhvZCxcbiAgICAgIHNpZ25hdHVyZVNlY3JldCxcbiAgICAgIHBhcmFtc1xuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogVXNlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LlxuICAgKi9cbiAgX3NldEp3dEdlbmVyYXRvcihnZW5lcmF0b3IpIHtcbiAgICB0aGlzLl9qd3RHZW5lcmF0b3IgPSBnZW5lcmF0b3I7XG4gIH1cblxuICAvKipcbiAgICogQHByaXZhdGVcbiAgICogVXNlZCBmb3IgdGVzdGluZyBwdXJwb3NlcyBvbmx5LlxuICAgKi9cbiAgX3NldEhhc2hHZW5lcmF0b3IoZ2VuZXJhdG9yKSB7XG4gICAgdGhpcy5faGFzaEdlbmVyYXRvciA9IGdlbmVyYXRvcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbnN1cmVzIGEgY3JlZGVudGlhbHMgaW5zdGFuY2UgaXMgdXNlZC5cbiAgICpcbiAgICogS2V5L1NlY3JldCBjcmVkZW50aWFscyBhcmUgb25seSBzdXBwb3J0ZWQgYXQgcHJlc2VudC5cbiAgICovXG4gIHN0YXRpYyBwYXJzZShvYmopIHtcbiAgICBpZiAob2JqIGluc3RhbmNlb2YgQ3JlZGVudGlhbHMpIHtcbiAgICAgIHJldHVybiBvYmo7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBuZXcgQ3JlZGVudGlhbHMoXG4gICAgICAgIG9iai5hcGlLZXksXG4gICAgICAgIG9iai5hcGlTZWNyZXQsXG4gICAgICAgIG9iai5wcml2YXRlS2V5LFxuICAgICAgICBvYmouYXBwbGljYXRpb25JZCxcbiAgICAgICAgb2JqLnNpZ25hdHVyZVNlY3JldCxcbiAgICAgICAgb2JqLnNpZ25hdHVyZU1ldGhvZFxuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ3JlZGVudGlhbHM7XG4iXX0=