"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var https = require("https");

var http = require("http");

var request = require("request");

var querystring = require("querystring");

class HttpClient {
  constructor(options, credentials) {
    this.credentials = credentials;
    this.host = options.host || "rest.nexmo.com";
    this.port = options.port || 443;
    this.https = options.https || https;
    this.http = options.http || http;
    this.headers = {
      "Content-Type": "application/x-www-form-urlencoded",
      Accept: "application/json"
    };
    this.logger = options.logger;
    this.timeout = options.timeout;
    this.requestLib = request;

    if (options.userAgent) {
      this.headers["User-Agent"] = options.userAgent;
    }
  }

  request(endpoint, method, callback) {
    var skipJsonParsing = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var customResponseParser = arguments.length > 4 ? arguments[4] : undefined;

    if (typeof method === "function") {
      callback = method;
      endpoint.method = endpoint.method || "GET";
    } else if (typeof method !== "undefined") {
      endpoint.method = method;
    }

    if (endpoint.method === "POST" || endpoint.method === "DELETE") {// TODO: verify the following fix is required
      // Fix broken due ot 411 Content-Length error now sent by Nexmo API
      // PL 2016-Sept-6 - commented out Content-Length 0
      // headers['Content-Length'] = 0;
    }

    var options = {
      host: endpoint.host ? endpoint.host : this.host,
      port: this.port,
      path: endpoint.path,
      method: endpoint.method,
      headers: Object.assign({}, this.headers)
    };

    if (this.timeout !== undefined) {
      options.timeout = this.timeout;
    } // Allow existing headers to be overridden
    // Allow new headers to be added


    if (endpoint.headers) {
      Object.keys(endpoint.headers).forEach(function (key) {
        options.headers[key] = endpoint.headers[key];
      });
    }

    if (this.credentials.signatureSecret && this.credentials.signatureMethod) {
      var splitPath = options.path.split(/\?(.+)/);
      var path = splitPath[0];
      var params = querystring.decode(splitPath[1]); // add timestamp if not already present

      if (!params.timestamp) {
        params.timestamp = new Date().getTime() / 1000 | 0; // floor to seconds

        params.timestamp = params.timestamp.toString();
      } // strip API Secret


      delete params.api_secret;
      var hash = this.credentials.generateSignature(params);
      var query = ""; // rebuild query

      Object.keys(params).sort().forEach(key => {
        query += "&" + key + "=" + encodeURI(params[key]);
      }); // replace the first & with ?

      query = query.replace(/&/i, "?");
      options.path = "".concat(path).concat(query, "&sig=").concat(hash);
    }

    this.logger.info("Request:", options, "\nBody:", endpoint.body);
    var request;

    if (options.port === 443) {
      request = this.https.request(options);
    } else {
      request = this.http.request(options);
    }

    request.end(endpoint.body); // Keep an array of String or Buffers,
    // depending on content type (binary or JSON) of response

    var responseData = [];
    request.on("response", response => {
      var isBinary = response.headers["content-type"] === "application/octet-stream";

      if (!isBinary) {
        response.setEncoding("utf8");
      }

      response.on("data", chunk => {
        responseData.push(chunk);
      });
      response.on("end", () => {
        this.logger.info("response ended:", response.statusCode);

        if (callback) {
          if (isBinary) {
            responseData = Buffer.concat(responseData);
          }

          this.__parseResponse(response, responseData, endpoint.method, callback, skipJsonParsing, customResponseParser);
        }
      });
      response.on("close", e => {
        if (e) {
          this.logger.error("problem with API request detailed stacktrace below ");
          this.logger.error(e);
          callback(e);
        }
      });
    });
    request.on("error", e => {
      this.logger.error("problem with API request detailed stacktrace below ");
      this.logger.error(e);
      callback(e);
    });
  }

  __parseResponse(httpResponse, data, method, callback, skipJsonParsing, customResponseParser) {
    var isArrayOrBuffer = data instanceof Array || data instanceof Buffer;

    if (!isArrayOrBuffer) {
      throw new Error("data should be of type Array or Buffer");
    }

    var status = httpResponse.statusCode;
    var headers = httpResponse.headers;
    var response = null;
    var error = null;

    try {
      if (status >= 500) {
        error = {
          message: "Server Error",
          statusCode: status
        };
      } else if (httpResponse.headers["content-type"] === "application/octet-stream") {
        response = data;
      } else if (status === 429) {
        // 429 does not return a parsable body
        if (!headers["retry-after"]) {
          // retry based on allowed per second
          var retryAfterMillis = method === "POST" ? 1000 / 2 : 1000 / 5;
          headers["retry-after"] = retryAfterMillis;
        }

        error = {
          body: data.join("")
        };
      } else if (status === 204) {
        response = null;
      } else if (status >= 400 || status < 200) {
        error = {
          body: JSON.parse(data.join("")),
          headers
        };
      } else if (method !== "DELETE") {
        if (!!skipJsonParsing) {
          response = data.join("");
        } else {
          response = JSON.parse(data.join(""));
        }
      } else {
        response = data;
      }
    } catch (parseError) {
      this.logger.error(parseError);
      this.logger.error("could not convert API response to JSON, above error is ignored and raw API response is returned to client");
      this.logger.error("Raw Error message from API ");
      this.logger.error("\"".concat(data, "\""));
      error = {
        status: status,
        message: "The API response could not be parsed.",
        body: data.join(""),
        parseError: parseError
      };
    }

    if (error) {
      error.statusCode = status;
      error.headers = headers;
    }

    if (typeof callback === "function") {
      if (typeof customResponseParser === "function") {
        // don't try to parse the response on errors
        if (response) {
          response = customResponseParser(response);
        }
      }

      callback(error, response);
    }
  }

  _addLimitedAccessMessageToErrors(callback, limitedAccessStatus) {
    return function (err, data) {
      if (err && err.status == limitedAccessStatus) {
        err._INFO_ = "This endpoint may need activating on your account. Please email support@nexmo.com for more information";
      }

      return callback(err, data);
    };
  }

  get(path, params, callback) {
    var useJwt = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : false;
    var useBasicAuth = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : false;

    if (!callback) {
      if (typeof params == "function") {
        callback = params;
        params = {};
      }
    }

    params = params || {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useJwt) {
      headers["Authorization"] = "Bearer ".concat(this.credentials.generateJwt());
    }

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      headers
    }, "GET", callback);
  }

  delete(path, callback, useJwt, useBasicAuth) {
    var params = {};

    if (!useJwt && !useBasicAuth) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    var headers = {};

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path,
      headers
    }, "DELETE", callback);
  }

  postFile(path, options, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    if (Object.keys(qs).length) {
      var joinChar = "?";

      if (path.indexOf(joinChar) !== -1) {
        joinChar = "&";
      }

      path = path + joinChar + querystring.stringify(qs);
    }

    var file = options.file;
    delete options.file; // We don't send this as metadata

    var formData = {};

    if (file) {
      formData["filedata"] = {
        value: file,
        options: {
          filename: options.filename || null
        }
      };
    }

    if (options.info) {
      formData.info = JSON.stringify(options.info);
    }

    if (options.url) {
      formData.url = options.url;
    }

    this.requestLib.post({
      url: "https://" + this.host + path,
      formData: formData,
      headers: {
        Authorization: "Bearer ".concat(this.credentials.generateJwt())
      }
    }, callback);
  }

  post(path, params, callback, useJwt) {
    var qs = {};

    if (!useJwt) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    this.request({
      path: path,
      body: querystring.stringify(params)
    }, "POST", callback);
  }

  postJson(path, params, callback, useJwt, useBasicAuth) {
    var qs = {};

    if (!useJwt && !useBasicAuth) {
      qs["api_key"] = this.credentials.apiKey;
      qs["api_secret"] = this.credentials.apiSecret;
    }

    var joinChar = "?";

    if (path.indexOf(joinChar) !== -1) {
      joinChar = "&";
    }

    path = path + joinChar + querystring.stringify(qs);
    var headers = {
      "Content-Type": "application/json"
    };

    if (useBasicAuth) {
      headers["Authorization"] = "Basic ".concat(Buffer.from(this.credentials.apiKey + ":" + this.credentials.apiSecret).toString("base64"));
    }

    this.request({
      path: path,
      body: JSON.stringify(params),
      headers
    }, "POST", callback);
  }

  postUseQueryString(path, params, callback, useJwt) {
    params = params || {};

    if (!useJwt) {
      params["api_key"] = this.credentials.apiKey;
      params["api_secret"] = this.credentials.apiSecret;
    }

    path = path + "?" + querystring.stringify(params);
    this.request({
      path: path
    }, "POST", callback);
  }

}

var _default = HttpClient;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9IdHRwQ2xpZW50LmpzIl0sIm5hbWVzIjpbImh0dHBzIiwicmVxdWlyZSIsImh0dHAiLCJyZXF1ZXN0IiwicXVlcnlzdHJpbmciLCJIdHRwQ2xpZW50IiwiY29uc3RydWN0b3IiLCJvcHRpb25zIiwiY3JlZGVudGlhbHMiLCJob3N0IiwicG9ydCIsImhlYWRlcnMiLCJBY2NlcHQiLCJsb2dnZXIiLCJ0aW1lb3V0IiwicmVxdWVzdExpYiIsInVzZXJBZ2VudCIsImVuZHBvaW50IiwibWV0aG9kIiwiY2FsbGJhY2siLCJza2lwSnNvblBhcnNpbmciLCJjdXN0b21SZXNwb25zZVBhcnNlciIsInBhdGgiLCJPYmplY3QiLCJhc3NpZ24iLCJ1bmRlZmluZWQiLCJrZXlzIiwiZm9yRWFjaCIsImtleSIsInNpZ25hdHVyZVNlY3JldCIsInNpZ25hdHVyZU1ldGhvZCIsInNwbGl0UGF0aCIsInNwbGl0IiwicGFyYW1zIiwiZGVjb2RlIiwidGltZXN0YW1wIiwiRGF0ZSIsImdldFRpbWUiLCJ0b1N0cmluZyIsImFwaV9zZWNyZXQiLCJoYXNoIiwiZ2VuZXJhdGVTaWduYXR1cmUiLCJxdWVyeSIsInNvcnQiLCJlbmNvZGVVUkkiLCJyZXBsYWNlIiwiaW5mbyIsImJvZHkiLCJlbmQiLCJyZXNwb25zZURhdGEiLCJvbiIsInJlc3BvbnNlIiwiaXNCaW5hcnkiLCJzZXRFbmNvZGluZyIsImNodW5rIiwicHVzaCIsInN0YXR1c0NvZGUiLCJCdWZmZXIiLCJjb25jYXQiLCJfX3BhcnNlUmVzcG9uc2UiLCJlIiwiZXJyb3IiLCJodHRwUmVzcG9uc2UiLCJkYXRhIiwiaXNBcnJheU9yQnVmZmVyIiwiQXJyYXkiLCJFcnJvciIsInN0YXR1cyIsIm1lc3NhZ2UiLCJyZXRyeUFmdGVyTWlsbGlzIiwiam9pbiIsIkpTT04iLCJwYXJzZSIsInBhcnNlRXJyb3IiLCJfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyIsImxpbWl0ZWRBY2Nlc3NTdGF0dXMiLCJlcnIiLCJfSU5GT18iLCJnZXQiLCJ1c2VKd3QiLCJ1c2VCYXNpY0F1dGgiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJzdHJpbmdpZnkiLCJnZW5lcmF0ZUp3dCIsImZyb20iLCJkZWxldGUiLCJwb3N0RmlsZSIsInFzIiwibGVuZ3RoIiwiam9pbkNoYXIiLCJpbmRleE9mIiwiZmlsZSIsImZvcm1EYXRhIiwidmFsdWUiLCJmaWxlbmFtZSIsInVybCIsInBvc3QiLCJBdXRob3JpemF0aW9uIiwicG9zdEpzb24iLCJwb3N0VXNlUXVlcnlTdHJpbmciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFJQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxPQUFELENBQW5COztBQUNBLElBQUlDLElBQUksR0FBR0QsT0FBTyxDQUFDLE1BQUQsQ0FBbEI7O0FBQ0EsSUFBSUUsT0FBTyxHQUFHRixPQUFPLENBQUMsU0FBRCxDQUFyQjs7QUFDQSxJQUFJRyxXQUFXLEdBQUdILE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUVBLE1BQU1JLFVBQU4sQ0FBaUI7QUFDZkMsRUFBQUEsV0FBVyxDQUFDQyxPQUFELEVBQVVDLFdBQVYsRUFBdUI7QUFDaEMsU0FBS0EsV0FBTCxHQUFtQkEsV0FBbkI7QUFDQSxTQUFLQyxJQUFMLEdBQVlGLE9BQU8sQ0FBQ0UsSUFBUixJQUFnQixnQkFBNUI7QUFDQSxTQUFLQyxJQUFMLEdBQVlILE9BQU8sQ0FBQ0csSUFBUixJQUFnQixHQUE1QjtBQUNBLFNBQUtWLEtBQUwsR0FBYU8sT0FBTyxDQUFDUCxLQUFSLElBQWlCQSxLQUE5QjtBQUNBLFNBQUtFLElBQUwsR0FBWUssT0FBTyxDQUFDTCxJQUFSLElBQWdCQSxJQUE1QjtBQUNBLFNBQUtTLE9BQUwsR0FBZTtBQUNiLHNCQUFnQixtQ0FESDtBQUViQyxNQUFBQSxNQUFNLEVBQUU7QUFGSyxLQUFmO0FBSUEsU0FBS0MsTUFBTCxHQUFjTixPQUFPLENBQUNNLE1BQXRCO0FBQ0EsU0FBS0MsT0FBTCxHQUFlUCxPQUFPLENBQUNPLE9BQXZCO0FBQ0EsU0FB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QUFQLEdBQWFsQixXQUFXLENBQUMrRSxTQUFaLENBQXNCbEQsTUFBdEIsQ0FBcEI7QUFFQSxTQUFLOUIsT0FBTCxDQUNFO0FBQ0VtQixNQUFBQSxJQUFJLEVBQUVBO0FBRFIsS0FERixFQUlFLE1BSkYsRUFLRUgsUUFMRjtBQU9EOztBQXJiYzs7ZUF3YkZkLFUiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgaHR0cHMgPSByZXF1aXJlKFwiaHR0cHNcIik7XG52YXIgaHR0cCA9IHJlcXVpcmUoXCJodHRwXCIpO1xudmFyIHJlcXVlc3QgPSByZXF1aXJlKFwicmVxdWVzdFwiKTtcbnZhciBxdWVyeXN0cmluZyA9IHJlcXVpcmUoXCJxdWVyeXN0cmluZ1wiKTtcblxuY2xhc3MgSHR0cENsaWVudCB7XG4gIGNvbnN0cnVjdG9yKG9wdGlvbnMsIGNyZWRlbnRpYWxzKSB7XG4gICAgdGhpcy5jcmVkZW50aWFscyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMuaG9zdCA9IG9wdGlvbnMuaG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCI7XG4gICAgdGhpcy5wb3J0ID0gb3B0aW9ucy5wb3J0IHx8IDQ0MztcbiAgICB0aGlzLmh0dHBzID0gb3B0aW9ucy5odHRwcyB8fCBodHRwcztcbiAgICB0aGlzLmh0dHAgPSBvcHRpb25zLmh0dHAgfHwgaHR0cDtcbiAgICB0aGlzLmhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZFwiLFxuICAgICAgQWNjZXB0OiBcImFwcGxpY2F0aW9uL2pzb25cIlxuICAgIH07XG4gICAgdGhpcy5sb2dnZXIgPSBvcHRpb25zLmxvZ2dlcjtcbiAgICB0aGlzLnRpbWVvdXQgPSBvcHRpb25zLnRpbWVvdXQ7XG4gICAgdGhpcy5yZXF1ZXN0TGliID0gcmVxdWVzdDtcblxuICAgIGlmIChvcHRpb25zLnVzZXJBZ2VudCkge1xuICAgICAgdGhpcy5oZWFkZXJzW1wiVXNlci1BZ2VudFwiXSA9IG9wdGlvbnMudXNlckFnZW50O1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3QoXG4gICAgZW5kcG9pbnQsXG4gICAgbWV0aG9kLFxuICAgIGNhbGxiYWNrLFxuICAgIHNraXBKc29uUGFyc2luZyA9IGZhbHNlLFxuICAgIGN1c3RvbVJlc3BvbnNlUGFyc2VyXG4gICkge1xuICAgIGlmICh0eXBlb2YgbWV0aG9kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNhbGxiYWNrID0gbWV0aG9kO1xuICAgICAgZW5kcG9pbnQubWV0aG9kID0gZW5kcG9pbnQubWV0aG9kIHx8IFwiR0VUXCI7XG4gICAgfSBlbHNlIGlmICh0eXBlb2YgbWV0aG9kICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgICBlbmRwb2ludC5tZXRob2QgPSBtZXRob2Q7XG4gICAgfVxuXG4gICAgaWYgKGVuZHBvaW50Lm1ldGhvZCA9PT0gXCJQT1NUXCIgfHwgZW5kcG9pbnQubWV0aG9kID09PSBcIkRFTEVURVwiKSB7XG4gICAgICAvLyBUT0RPOiB2ZXJpZnkgdGhlIGZvbGxvd2luZyBmaXggaXMgcmVxdWlyZWRcbiAgICAgIC8vIEZpeCBicm9rZW4gZHVlIG90IDQxMSBDb250ZW50LUxlbmd0aCBlcnJvciBub3cgc2VudCBieSBOZXhtbyBBUElcbiAgICAgIC8vIFBMIDIwMTYtU2VwdC02IC0gY29tbWVudGVkIG91dCBDb250ZW50LUxlbmd0aCAwXG4gICAgICAvLyBoZWFkZXJzWydDb250ZW50LUxlbmd0aCddID0gMDtcbiAgICB9XG4gICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICBob3N0OiBlbmRwb2ludC5ob3N0ID8gZW5kcG9pbnQuaG9zdCA6IHRoaXMuaG9zdCxcbiAgICAgIHBvcnQ6IHRoaXMucG9ydCxcbiAgICAgIHBhdGg6IGVuZHBvaW50LnBhdGgsXG4gICAgICBtZXRob2Q6IGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgIGhlYWRlcnM6IE9iamVjdC5hc3NpZ24oe30sIHRoaXMuaGVhZGVycylcbiAgICB9O1xuXG4gICAgaWYgKHRoaXMudGltZW91dCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvcHRpb25zLnRpbWVvdXQgPSB0aGlzLnRpbWVvdXQ7XG4gICAgfVxuXG4gICAgLy8gQWxsb3cgZXhpc3RpbmcgaGVhZGVycyB0byBiZSBvdmVycmlkZGVuXG4gICAgLy8gQWxsb3cgbmV3IGhlYWRlcnMgdG8gYmUgYWRkZWRcbiAgICBpZiAoZW5kcG9pbnQuaGVhZGVycykge1xuICAgICAgT2JqZWN0LmtleXMoZW5kcG9pbnQuaGVhZGVycykuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgb3B0aW9ucy5oZWFkZXJzW2tleV0gPSBlbmRwb2ludC5oZWFkZXJzW2tleV07XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5jcmVkZW50aWFscy5zaWduYXR1cmVTZWNyZXQgJiYgdGhpcy5jcmVkZW50aWFscy5zaWduYXR1cmVNZXRob2QpIHtcbiAgICAgIGNvbnN0IHNwbGl0UGF0aCA9IG9wdGlvbnMucGF0aC5zcGxpdCgvXFw/KC4rKS8pO1xuICAgICAgY29uc3QgcGF0aCA9IHNwbGl0UGF0aFswXTtcblxuICAgICAgdmFyIHBhcmFtcyA9IHF1ZXJ5c3RyaW5nLmRlY29kZShzcGxpdFBhdGhbMV0pO1xuXG4gICAgICAvLyBhZGQgdGltZXN0YW1wIGlmIG5vdCBhbHJlYWR5IHByZXNlbnRcbiAgICAgIGlmICghcGFyYW1zLnRpbWVzdGFtcCkge1xuICAgICAgICBwYXJhbXMudGltZXN0YW1wID0gKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTAwMCkgfCAwOyAvLyBmbG9vciB0byBzZWNvbmRzXG4gICAgICAgIHBhcmFtcy50aW1lc3RhbXAgPSBwYXJhbXMudGltZXN0YW1wLnRvU3RyaW5nKCk7XG4gICAgICB9XG5cbiAgICAgIC8vIHN0cmlwIEFQSSBTZWNyZXRcbiAgICAgIGRlbGV0ZSBwYXJhbXMuYXBpX3NlY3JldDtcblxuICAgICAgY29uc3QgaGFzaCA9IHRoaXMuY3JlZGVudGlhbHMuZ2VuZXJhdGVTaWduYXR1cmUocGFyYW1zKTtcblxuICAgICAgdmFyIHF1ZXJ5ID0gXCJcIjtcblxuICAgICAgLy8gcmVidWlsZCBxdWVyeVxuICAgICAgT2JqZWN0LmtleXMocGFyYW1zKVxuICAgICAgICAuc29ydCgpXG4gICAgICAgIC5mb3JFYWNoKGtleSA9PiB7XG4gICAgICAgICAgcXVlcnkgKz0gXCImXCIgKyBrZXkgKyBcIj1cIiArIGVuY29kZVVSSShwYXJhbXNba2V5XSk7XG4gICAgICAgIH0pO1xuXG4gICAgICAvLyByZXBsYWNlIHRoZSBmaXJzdCAmIHdpdGggP1xuICAgICAgcXVlcnkgPSBxdWVyeS5yZXBsYWNlKC8mL2ksIFwiP1wiKTtcblxuICAgICAgb3B0aW9ucy5wYXRoID0gYCR7cGF0aH0ke3F1ZXJ5fSZzaWc9JHtoYXNofWA7XG4gICAgfVxuXG4gICAgdGhpcy5sb2dnZXIuaW5mbyhcIlJlcXVlc3Q6XCIsIG9wdGlvbnMsIFwiXFxuQm9keTpcIiwgZW5kcG9pbnQuYm9keSk7XG4gICAgdmFyIHJlcXVlc3Q7XG5cbiAgICBpZiAob3B0aW9ucy5wb3J0ID09PSA0NDMpIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHBzLnJlcXVlc3Qob3B0aW9ucyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlcXVlc3QgPSB0aGlzLmh0dHAucmVxdWVzdChvcHRpb25zKTtcbiAgICB9XG5cbiAgICByZXF1ZXN0LmVuZChlbmRwb2ludC5ib2R5KTtcblxuICAgIC8vIEtlZXAgYW4gYXJyYXkgb2YgU3RyaW5nIG9yIEJ1ZmZlcnMsXG4gICAgLy8gZGVwZW5kaW5nIG9uIGNvbnRlbnQgdHlwZSAoYmluYXJ5IG9yIEpTT04pIG9mIHJlc3BvbnNlXG4gICAgdmFyIHJlc3BvbnNlRGF0YSA9IFtdO1xuXG4gICAgcmVxdWVzdC5vbihcInJlc3BvbnNlXCIsIHJlc3BvbnNlID0+IHtcbiAgICAgIHZhciBpc0JpbmFyeSA9XG4gICAgICAgIHJlc3BvbnNlLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPT09IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCI7XG4gICAgICBpZiAoIWlzQmluYXJ5KSB7XG4gICAgICAgIHJlc3BvbnNlLnNldEVuY29kaW5nKFwidXRmOFwiKTtcbiAgICAgIH1cblxuICAgICAgcmVzcG9uc2Uub24oXCJkYXRhXCIsIGNodW5rID0+IHtcbiAgICAgICAgcmVzcG9uc2VEYXRhLnB1c2goY2h1bmspO1xuICAgICAgfSk7XG5cbiAgICAgIHJlc3BvbnNlLm9uKFwiZW5kXCIsICgpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhcInJlc3BvbnNlIGVuZGVkOlwiLCByZXNwb25zZS5zdGF0dXNDb2RlKTtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgaWYgKGlzQmluYXJ5KSB7XG4gICAgICAgICAgICByZXNwb25zZURhdGEgPSBCdWZmZXIuY29uY2F0KHJlc3BvbnNlRGF0YSk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGhpcy5fX3BhcnNlUmVzcG9uc2UoXG4gICAgICAgICAgICByZXNwb25zZSxcbiAgICAgICAgICAgIHJlc3BvbnNlRGF0YSxcbiAgICAgICAgICAgIGVuZHBvaW50Lm1ldGhvZCxcbiAgICAgICAgICAgIGNhbGxiYWNrLFxuICAgICAgICAgICAgc2tpcEpzb25QYXJzaW5nLFxuICAgICAgICAgICAgY3VzdG9tUmVzcG9uc2VQYXJzZXJcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIHJlc3BvbnNlLm9uKFwiY2xvc2VcIiwgZSA9PiB7XG4gICAgICAgIGlmIChlKSB7XG4gICAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgICBcInByb2JsZW0gd2l0aCBBUEkgcmVxdWVzdCBkZXRhaWxlZCBzdGFja3RyYWNlIGJlbG93IFwiXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLmxvZ2dlci5lcnJvcihlKTtcbiAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmVxdWVzdC5vbihcImVycm9yXCIsIGUgPT4ge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXCJwcm9ibGVtIHdpdGggQVBJIHJlcXVlc3QgZGV0YWlsZWQgc3RhY2t0cmFjZSBiZWxvdyBcIik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihlKTtcbiAgICAgIGNhbGxiYWNrKGUpO1xuICAgIH0pO1xuICB9XG5cbiAgX19wYXJzZVJlc3BvbnNlKFxuICAgIGh0dHBSZXNwb25zZSxcbiAgICBkYXRhLFxuICAgIG1ldGhvZCxcbiAgICBjYWxsYmFjayxcbiAgICBza2lwSnNvblBhcnNpbmcsXG4gICAgY3VzdG9tUmVzcG9uc2VQYXJzZXJcbiAgKSB7XG4gICAgY29uc3QgaXNBcnJheU9yQnVmZmVyID0gZGF0YSBpbnN0YW5jZW9mIEFycmF5IHx8IGRhdGEgaW5zdGFuY2VvZiBCdWZmZXI7XG4gICAgaWYgKCFpc0FycmF5T3JCdWZmZXIpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcImRhdGEgc2hvdWxkIGJlIG9mIHR5cGUgQXJyYXkgb3IgQnVmZmVyXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXR1cyA9IGh0dHBSZXNwb25zZS5zdGF0dXNDb2RlO1xuICAgIGNvbnN0IGhlYWRlcnMgPSBodHRwUmVzcG9uc2UuaGVhZGVycztcblxuICAgIGxldCByZXNwb25zZSA9IG51bGw7XG4gICAgdmFyIGVycm9yID0gbnVsbDtcblxuICAgIHRyeSB7XG4gICAgICBpZiAoc3RhdHVzID49IDUwMCkge1xuICAgICAgICBlcnJvciA9IHtcbiAgICAgICAgICBtZXNzYWdlOiBcIlNlcnZlciBFcnJvclwiLFxuICAgICAgICAgIHN0YXR1c0NvZGU6IHN0YXR1c1xuICAgICAgICB9O1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgaHR0cFJlc3BvbnNlLmhlYWRlcnNbXCJjb250ZW50LXR5cGVcIl0gPT09IFwiYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtXCJcbiAgICAgICkge1xuICAgICAgICByZXNwb25zZSA9IGRhdGE7XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gNDI5KSB7XG4gICAgICAgIC8vIDQyOSBkb2VzIG5vdCByZXR1cm4gYSBwYXJzYWJsZSBib2R5XG4gICAgICAgIGlmICghaGVhZGVyc1tcInJldHJ5LWFmdGVyXCJdKSB7XG4gICAgICAgICAgLy8gcmV0cnkgYmFzZWQgb24gYWxsb3dlZCBwZXIgc2Vjb25kXG4gICAgICAgICAgY29uc3QgcmV0cnlBZnRlck1pbGxpcyA9IG1ldGhvZCA9PT0gXCJQT1NUXCIgPyAxMDAwIC8gMiA6IDEwMDAgLyA1O1xuICAgICAgICAgIGhlYWRlcnNbXCJyZXRyeS1hZnRlclwiXSA9IHJldHJ5QWZ0ZXJNaWxsaXM7XG4gICAgICAgIH1cbiAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgYm9keTogZGF0YS5qb2luKFwiXCIpXG4gICAgICAgIH07XG4gICAgICB9IGVsc2UgaWYgKHN0YXR1cyA9PT0gMjA0KSB7XG4gICAgICAgIHJlc3BvbnNlID0gbnVsbDtcbiAgICAgIH0gZWxzZSBpZiAoc3RhdHVzID49IDQwMCB8fCBzdGF0dXMgPCAyMDApIHtcbiAgICAgICAgZXJyb3IgPSB7XG4gICAgICAgICAgYm9keTogSlNPTi5wYXJzZShkYXRhLmpvaW4oXCJcIikpLFxuICAgICAgICAgIGhlYWRlcnNcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAobWV0aG9kICE9PSBcIkRFTEVURVwiKSB7XG4gICAgICAgIGlmICghIXNraXBKc29uUGFyc2luZykge1xuICAgICAgICAgIHJlc3BvbnNlID0gZGF0YS5qb2luKFwiXCIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc3BvbnNlID0gSlNPTi5wYXJzZShkYXRhLmpvaW4oXCJcIikpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNwb25zZSA9IGRhdGE7XG4gICAgICB9XG4gICAgfSBjYXRjaCAocGFyc2VFcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IocGFyc2VFcnJvcik7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgXCJjb3VsZCBub3QgY29udmVydCBBUEkgcmVzcG9uc2UgdG8gSlNPTiwgYWJvdmUgZXJyb3IgaXMgaWdub3JlZCBhbmQgcmF3IEFQSSByZXNwb25zZSBpcyByZXR1cm5lZCB0byBjbGllbnRcIlxuICAgICAgKTtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKFwiUmF3IEVycm9yIG1lc3NhZ2UgZnJvbSBBUEkgXCIpO1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoYFwiJHtkYXRhfVwiYCk7XG5cbiAgICAgIGVycm9yID0ge1xuICAgICAgICBzdGF0dXM6IHN0YXR1cyxcbiAgICAgICAgbWVzc2FnZTogXCJUaGUgQVBJIHJlc3BvbnNlIGNvdWxkIG5vdCBiZSBwYXJzZWQuXCIsXG4gICAgICAgIGJvZHk6IGRhdGEuam9pbihcIlwiKSxcbiAgICAgICAgcGFyc2VFcnJvcjogcGFyc2VFcnJvclxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3IpIHtcbiAgICAgIGVycm9yLnN0YXR1c0NvZGUgPSBzdGF0dXM7XG4gICAgICBlcnJvci5oZWFkZXJzID0gaGVhZGVycztcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGlmICh0eXBlb2YgY3VzdG9tUmVzcG9uc2VQYXJzZXIgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAvLyBkb24ndCB0cnkgdG8gcGFyc2UgdGhlIHJlc3BvbnNlIG9uIGVycm9yc1xuICAgICAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgICAgICByZXNwb25zZSA9IGN1c3RvbVJlc3BvbnNlUGFyc2VyKHJlc3BvbnNlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY2FsbGJhY2soZXJyb3IsIHJlc3BvbnNlKTtcbiAgICB9XG4gIH1cblxuICBfYWRkTGltaXRlZEFjY2Vzc01lc3NhZ2VUb0Vycm9ycyhjYWxsYmFjaywgbGltaXRlZEFjY2Vzc1N0YXR1cykge1xuICAgIHJldHVybiBmdW5jdGlvbihlcnIsIGRhdGEpIHtcbiAgICAgIGlmIChlcnIgJiYgZXJyLnN0YXR1cyA9PSBsaW1pdGVkQWNjZXNzU3RhdHVzKSB7XG4gICAgICAgIGVyci5fSU5GT18gPVxuICAgICAgICAgIFwiVGhpcyBlbmRwb2ludCBtYXkgbmVlZCBhY3RpdmF0aW5nIG9uIHlvdXIgYWNjb3VudC4gUGxlYXNlIGVtYWlsIHN1cHBvcnRAbmV4bW8uY29tIGZvciBtb3JlIGluZm9ybWF0aW9uXCI7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjYWxsYmFjayhlcnIsIGRhdGEpO1xuICAgIH07XG4gIH1cblxuICBnZXQocGF0aCwgcGFyYW1zLCBjYWxsYmFjaywgdXNlSnd0ID0gZmFsc2UsIHVzZUJhc2ljQXV0aCA9IGZhbHNlKSB7XG4gICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgaWYgKHR5cGVvZiBwYXJhbXMgPT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gcGFyYW1zO1xuICAgICAgICBwYXJhbXMgPSB7fTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XG4gICAgaWYgKCF1c2VKd3QgJiYgIXVzZUJhc2ljQXV0aCkge1xuICAgICAgcGFyYW1zW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcGFyYW1zW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0O1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIGNvbnN0IGhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIlxuICAgIH07XG4gICAgaWYgKHVzZUp3dCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmVhcmVyICR7dGhpcy5jcmVkZW50aWFscy5nZW5lcmF0ZUp3dCgpfWA7XG4gICAgfVxuICAgIGlmICh1c2VCYXNpY0F1dGgpIHtcbiAgICAgIGhlYWRlcnNbXCJBdXRob3JpemF0aW9uXCJdID0gYEJhc2ljICR7QnVmZmVyLmZyb20oXG4gICAgICAgIHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5ICsgXCI6XCIgKyB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldFxuICAgICAgKS50b1N0cmluZyhcImJhc2U2NFwiKX1gO1xuICAgIH1cblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgaGVhZGVyc1xuICAgICAgfSxcbiAgICAgIFwiR0VUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBkZWxldGUocGF0aCwgY2FsbGJhY2ssIHVzZUp3dCwgdXNlQmFzaWNBdXRoKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHBhcmFtc1tcImFwaV9rZXlcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaUtleTtcbiAgICAgIHBhcmFtc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBsZXQgaGVhZGVycyA9IHt9O1xuXG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuICAgIHBhdGggPSBwYXRoICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocGFyYW1zKTtcblxuICAgIHRoaXMucmVxdWVzdChcbiAgICAgIHtcbiAgICAgICAgcGF0aDogcGF0aCxcbiAgICAgICAgaGVhZGVyc1xuICAgICAgfSxcbiAgICAgIFwiREVMRVRFXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0RmlsZShwYXRoLCBvcHRpb25zLCBjYWxsYmFjaywgdXNlSnd0KSB7XG4gICAgbGV0IHFzID0ge307XG4gICAgaWYgKCF1c2VKd3QpIHtcbiAgICAgIHFzW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgaWYgKE9iamVjdC5rZXlzKHFzKS5sZW5ndGgpIHtcbiAgICAgIGxldCBqb2luQ2hhciA9IFwiP1wiO1xuICAgICAgaWYgKHBhdGguaW5kZXhPZihqb2luQ2hhcikgIT09IC0xKSB7XG4gICAgICAgIGpvaW5DaGFyID0gXCImXCI7XG4gICAgICB9XG4gICAgICBwYXRoID0gcGF0aCArIGpvaW5DaGFyICsgcXVlcnlzdHJpbmcuc3RyaW5naWZ5KHFzKTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlID0gb3B0aW9ucy5maWxlO1xuICAgIGRlbGV0ZSBvcHRpb25zLmZpbGU7IC8vIFdlIGRvbid0IHNlbmQgdGhpcyBhcyBtZXRhZGF0YVxuXG4gICAgY29uc3QgZm9ybURhdGEgPSB7fTtcblxuICAgIGlmIChmaWxlKSB7XG4gICAgICBmb3JtRGF0YVtcImZpbGVkYXRhXCJdID0ge1xuICAgICAgICB2YWx1ZTogZmlsZSxcbiAgICAgICAgb3B0aW9uczoge1xuICAgICAgICAgIGZpbGVuYW1lOiBvcHRpb25zLmZpbGVuYW1lIHx8IG51bGxcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy5pbmZvKSB7XG4gICAgICBmb3JtRGF0YS5pbmZvID0gSlNPTi5zdHJpbmdpZnkob3B0aW9ucy5pbmZvKTtcbiAgICB9XG5cbiAgICBpZiAob3B0aW9ucy51cmwpIHtcbiAgICAgIGZvcm1EYXRhLnVybCA9IG9wdGlvbnMudXJsO1xuICAgIH1cblxuICAgIHRoaXMucmVxdWVzdExpYi5wb3N0KFxuICAgICAge1xuICAgICAgICB1cmw6IFwiaHR0cHM6Ly9cIiArIHRoaXMuaG9zdCArIHBhdGgsXG4gICAgICAgIGZvcm1EYXRhOiBmb3JtRGF0YSxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgIEF1dGhvcml6YXRpb246IGBCZWFyZXIgJHt0aGlzLmNyZWRlbnRpYWxzLmdlbmVyYXRlSnd0KCl9YFxuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgcG9zdChwYXRoLCBwYXJhbXMsIGNhbGxiYWNrLCB1c2VKd3QpIHtcbiAgICBsZXQgcXMgPSB7fTtcbiAgICBpZiAoIXVzZUp3dCkge1xuICAgICAgcXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlLZXk7XG4gICAgICBxc1tcImFwaV9zZWNyZXRcIl0gPSB0aGlzLmNyZWRlbnRpYWxzLmFwaVNlY3JldDtcbiAgICB9XG5cbiAgICBsZXQgam9pbkNoYXIgPSBcIj9cIjtcbiAgICBpZiAocGF0aC5pbmRleE9mKGpvaW5DaGFyKSAhPT0gLTEpIHtcbiAgICAgIGpvaW5DaGFyID0gXCImXCI7XG4gICAgfVxuXG4gICAgcGF0aCA9IHBhdGggKyBqb2luQ2hhciArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShxcyk7XG5cbiAgICB0aGlzLnJlcXVlc3QoXG4gICAgICB7XG4gICAgICAgIHBhdGg6IHBhdGgsXG4gICAgICAgIGJvZHk6IHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShwYXJhbXMpXG4gICAgICB9LFxuICAgICAgXCJQT1NUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0SnNvbihwYXRoLCBwYXJhbXMsIGNhbGxiYWNrLCB1c2VKd3QsIHVzZUJhc2ljQXV0aCkge1xuICAgIGxldCBxcyA9IHt9O1xuICAgIGlmICghdXNlSnd0ICYmICF1c2VCYXNpY0F1dGgpIHtcbiAgICAgIHFzW1wiYXBpX2tleVwiXSA9IHRoaXMuY3JlZGVudGlhbHMuYXBpS2V5O1xuICAgICAgcXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgbGV0IGpvaW5DaGFyID0gXCI/XCI7XG4gICAgaWYgKHBhdGguaW5kZXhPZihqb2luQ2hhcikgIT09IC0xKSB7XG4gICAgICBqb2luQ2hhciA9IFwiJlwiO1xuICAgIH1cblxuICAgIHBhdGggPSBwYXRoICsgam9pbkNoYXIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkocXMpO1xuXG4gICAgbGV0IGhlYWRlcnMgPSB7XG4gICAgICBcIkNvbnRlbnQtVHlwZVwiOiBcImFwcGxpY2F0aW9uL2pzb25cIlxuICAgIH07XG4gICAgaWYgKHVzZUJhc2ljQXV0aCkge1xuICAgICAgaGVhZGVyc1tcIkF1dGhvcml6YXRpb25cIl0gPSBgQmFzaWMgJHtCdWZmZXIuZnJvbShcbiAgICAgICAgdGhpcy5jcmVkZW50aWFscy5hcGlLZXkgKyBcIjpcIiArIHRoaXMuY3JlZGVudGlhbHMuYXBpU2VjcmV0XG4gICAgICApLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWA7XG4gICAgfVxuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoLFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShwYXJhbXMpLFxuICAgICAgICBoZWFkZXJzXG4gICAgICB9LFxuICAgICAgXCJQT1NUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cblxuICBwb3N0VXNlUXVlcnlTdHJpbmcocGF0aCwgcGFyYW1zLCBjYWxsYmFjaywgdXNlSnd0KSB7XG4gICAgcGFyYW1zID0gcGFyYW1zIHx8IHt9O1xuICAgIGlmICghdXNlSnd0KSB7XG4gICAgICBwYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlLZXk7XG4gICAgICBwYXJhbXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkZW50aWFscy5hcGlTZWNyZXQ7XG4gICAgfVxuXG4gICAgcGF0aCA9IHBhdGggKyBcIj9cIiArIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeShwYXJhbXMpO1xuXG4gICAgdGhpcy5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBwYXRoXG4gICAgICB9LFxuICAgICAgXCJQT1NUXCIsXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSHR0cENsaWVudDtcbiJdfQ==