"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Pricing = _interopRequireDefault(require("./Pricing"));

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Number {
  static get PATH() {
    return "/number";
  }

  static get ERROR_MESSAGES() {
    return {
      optionsNotAnObject: "Options parameter should be a dictionary. Check the docs for valid properties for options",
      countrycode: "Invalid Country Code",
      msisdn: "Invalid MSISDN passed"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition Number options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
    this._pricing = new _Pricing.default(credentials, options);
  }
  /**
   * TODO: remove with next major release
   */


  getPricing() {
    this._pricing.get.apply(this, arguments);
  }
  /**
   * TODO: remove with next major release
   */


  getPhonePricing() {
    this._pricing.getPhone.apply(this, arguments);
  }
  /**
   * TODO: document
   */


  get(options, callback) {
    if (typeof options === "function") {
      callback = options;
      options = {};
    } else if (typeof options !== "object") {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.optionsNotAnObject));
    }

    options.api_key = options.api_key || this.creds.apiKey;
    options.api_secret = options.api_secret || this.creds.apiSecret;
    this.options.httpClient.request({
      path: _Utils.default.createPathWithQuery("/account".concat(Number.PATH, "s"), options)
    }, callback);
  }
  /**
   * TODO: document
   */


  search(countryCode, pattern, callback) {
    var params = {
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    };

    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else {
      params["country"] = countryCode;

      if (typeof pattern === "function") {
        callback = pattern;
      } else if (typeof pattern === "object") {
        for (var arg in pattern) {
          params[arg] = pattern[arg];
        }
      } else {
        params["pattern"] = pattern;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/search"), params)
      }, callback);
    }
  }
  /**
   * TODO: document
   */


  buy(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/buy"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  cancel(countryCode, msisdn, targetApiKey, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      var opts = {
        country: countryCode,
        msisdn,
        api_key: this.creds.apiKey,
        api_secret: this.creds.apiSecret
      };

      if (targetApiKey instanceof Function) {
        callback = targetApiKey;
      } else {
        opts.target_api_key = targetApiKey;
      }

      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/cancel"), opts)
      }, "POST", callback);
    }
  }
  /**
   * TODO: document
   */


  update(countryCode, msisdn, params, callback) {
    if (!countryCode || countryCode.length !== 2) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.countrycode));
    } else if (!msisdn) {
      _Utils.default.sendError(callback, new Error(Number.ERROR_MESSAGES.msisdn));
    } else {
      params["country"] = countryCode;
      params["msisdn"] = msisdn;
      params["api_key"] = this.creds.apiKey;
      params["api_secret"] = this.creds.apiSecret;
      this.options.httpClient.request({
        path: _Utils.default.createPathWithQuery("".concat(Number.PATH, "/update"), params)
      }, "POST", callback);
    }
  }

}

var _default = Number;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9OdW1iZXIuanMiXSwibmFtZXMiOlsiTnVtYmVyIiwiUEFUSCIsIkVSUk9SX01FU1NBR0VTIiwib3B0aW9uc05vdEFuT2JqZWN0IiwiY291bnRyeWNvZGUiLCJtc2lzZG4iLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3ByaWNpbmciLCJQcmljaW5nIiwiZ2V0UHJpY2luZyIsImdldCIsImFwcGx5IiwiYXJndW1lbnRzIiwiZ2V0UGhvbmVQcmljaW5nIiwiZ2V0UGhvbmUiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlfa2V5IiwiYXBpS2V5IiwiYXBpX3NlY3JldCIsImFwaVNlY3JldCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwicGF0aCIsImNyZWF0ZVBhdGhXaXRoUXVlcnkiLCJzZWFyY2giLCJjb3VudHJ5Q29kZSIsInBhdHRlcm4iLCJwYXJhbXMiLCJsZW5ndGgiLCJhcmciLCJidXkiLCJ0YXJnZXRBcGlLZXkiLCJvcHRzIiwiY291bnRyeSIsIkZ1bmN0aW9uIiwidGFyZ2V0X2FwaV9rZXkiLCJjYW5jZWwiLCJ1cGRhdGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FBRUE7O0FBRUE7Ozs7QUFFQSxNQUFNQSxNQUFOLENBQWE7QUFDWCxhQUFXQyxJQUFYLEdBQWtCO0FBQ2hCLFdBQU8sU0FBUDtBQUNEOztBQUVELGFBQVdDLGNBQVgsR0FBNEI7QUFDMUIsV0FBTztBQUNMQyxNQUFBQSxrQkFBa0IsRUFDaEIsMkZBRkc7QUFHTEMsTUFBQUEsV0FBVyxFQUFFLHNCQUhSO0FBSUxDLE1BQUFBLE1BQU0sRUFBRTtBQUpILEtBQVA7QUFNRDtBQUNEOzs7Ozs7OztBQU1BQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBNEI7QUFBQSxRQUFkQyxPQUFjLHVFQUFKLEVBQUk7QUFDckMsU0FBS0MsS0FBTCxHQUFhRixXQUFiO0FBQ0EsU0FBS0MsT0FBTCxHQUFlQSxPQUFm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Y0FBUCxDQUFzQkUsV0FBaEMsQ0FBMUI7QUFDRCxLQUZELE1BRU8sSUFBSSxDQUFDQyxNQUFMLEVBQWE7QUFDbEJjLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVyQixNQUFNLENBQUNFLGNBQVAsQ0FBc0JHLE1BQWhDLENBQTFCO0FBQ0QsS0FGTSxNQUVBO0FBQ0w0QixNQUFBQSxNQUFNLENBQUMsU0FBRCxDQUFOLEdBQW9CRixXQUFwQjtBQUNBRSxNQUFBQSxNQUFNLENBQUMsUUFBRCxDQUFOLEdBQW1CNUIsTUFBbkI7QUFDQTRCLE1BQUFBLE1BQU0sQ0FBQyxTQUFELENBQU4sR0FBb0IsS0FBS3hCLEtBQUwsQ0FBV2MsTUFBL0I7QUFDQVUsTUFBQUEsTUFBTSxDQUFDLFlBQUQsQ0FBTixHQUF1QixLQUFLeEIsS0FBTCxDQUFXZ0IsU0FBbEM7QUFFQSxXQUFLakIsT0FBTCxDQUFha0IsVUFBYixDQUF3QkMsT0FBeEIsQ0FDRTtBQUNFQyxRQUFBQSxJQUFJLEVBQUVULGVBQU1VLG1CQUFOLFdBQTZCN0IsTUFBTSxDQUFDQyxJQUFwQyxjQUFtRGdDLE1BQW5EO0FBRFIsT0FERixFQUlFLE1BSkYsRUFLRWYsUUFMRjtBQU9EO0FBQ0Y7O0FBckxVOztlQXdMRWxCLE0iLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFByaWNpbmcgZnJvbSBcIi4vUHJpY2luZ1wiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuY2xhc3MgTnVtYmVyIHtcbiAgc3RhdGljIGdldCBQQVRIKCkge1xuICAgIHJldHVybiBcIi9udW1iZXJcIjtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgRVJST1JfTUVTU0FHRVMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9wdGlvbnNOb3RBbk9iamVjdDpcbiAgICAgICAgXCJPcHRpb25zIHBhcmFtZXRlciBzaG91bGQgYmUgYSBkaWN0aW9uYXJ5LiBDaGVjayB0aGUgZG9jcyBmb3IgdmFsaWQgcHJvcGVydGllcyBmb3Igb3B0aW9uc1wiLFxuICAgICAgY291bnRyeWNvZGU6IFwiSW52YWxpZCBDb3VudHJ5IENvZGVcIixcbiAgICAgIG1zaXNkbjogXCJJbnZhbGlkIE1TSVNETiBwYXNzZWRcIlxuICAgIH07XG4gIH1cbiAgLyoqXG4gICAqIEBwYXJhbSB7Q3JlZGVudGlhbHN9IGNyZWRlbnRpYWxzXG4gICAqICAgIGNyZWRlbnRpYWxzIHRvIGJlIHVzZWQgd2hlbiBpbnRlcmFjdGluZyB3aXRoIHRoZSBBUEkuXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zXG4gICAqICAgIEFkZGl0aW9uIE51bWJlciBvcHRpb25zLlxuICAgKi9cbiAgY29uc3RydWN0b3IoY3JlZGVudGlhbHMsIG9wdGlvbnMgPSB7fSkge1xuICAgIHRoaXMuY3JlZHMgPSBjcmVkZW50aWFscztcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuXG4gICAgdGhpcy5fcHJpY2luZyA9IG5ldyBQcmljaW5nKGNyZWRlbnRpYWxzLCBvcHRpb25zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHJlbGVhc2VcbiAgICovXG4gIGdldFByaWNpbmcoKSB7XG4gICAgdGhpcy5fcHJpY2luZy5nZXQuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiByZW1vdmUgd2l0aCBuZXh0IG1ham9yIHJlbGVhc2VcbiAgICovXG4gIGdldFBob25lUHJpY2luZygpIHtcbiAgICB0aGlzLl9wcmljaW5nLmdldFBob25lLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIGdldChvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICBjYWxsYmFjayA9IG9wdGlvbnM7XG4gICAgICBvcHRpb25zID0ge307XG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0aW9ucyAhPT0gXCJvYmplY3RcIikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5vcHRpb25zTm90QW5PYmplY3QpXG4gICAgICApO1xuICAgIH1cblxuICAgIG9wdGlvbnMuYXBpX2tleSA9IG9wdGlvbnMuYXBpX2tleSB8fCB0aGlzLmNyZWRzLmFwaUtleTtcbiAgICBvcHRpb25zLmFwaV9zZWNyZXQgPSBvcHRpb25zLmFwaV9zZWNyZXQgfHwgdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG5cbiAgICB0aGlzLm9wdGlvbnMuaHR0cENsaWVudC5yZXF1ZXN0KFxuICAgICAge1xuICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAvYWNjb3VudCR7TnVtYmVyLlBBVEh9c2AsIG9wdGlvbnMpXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZWFyY2goY291bnRyeUNvZGUsIHBhdHRlcm4sIGNhbGxiYWNrKSB7XG4gICAgbGV0IHBhcmFtcyA9IHtcbiAgICAgIGFwaV9rZXk6IHRoaXMuY3JlZHMuYXBpS2V5LFxuICAgICAgYXBpX3NlY3JldDogdGhpcy5jcmVkcy5hcGlTZWNyZXRcbiAgICB9O1xuICAgIGlmICghY291bnRyeUNvZGUgfHwgY291bnRyeUNvZGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMuY291bnRyeWNvZGUpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zW1wiY291bnRyeVwiXSA9IGNvdW50cnlDb2RlO1xuICAgICAgaWYgKHR5cGVvZiBwYXR0ZXJuID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBwYXR0ZXJuO1xuICAgICAgfSBlbHNlIGlmICh0eXBlb2YgcGF0dGVybiA9PT0gXCJvYmplY3RcIikge1xuICAgICAgICBmb3IgKHZhciBhcmcgaW4gcGF0dGVybikge1xuICAgICAgICAgIHBhcmFtc1thcmddID0gcGF0dGVyblthcmddO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwYXJhbXNbXCJwYXR0ZXJuXCJdID0gcGF0dGVybjtcbiAgICAgIH1cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS9zZWFyY2hgLCBwYXJhbXMpXG4gICAgICAgIH0sXG4gICAgICAgIGNhbGxiYWNrXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgYnV5KGNvdW50cnlDb2RlLCBtc2lzZG4sIHRhcmdldEFwaUtleSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIWNvdW50cnlDb2RlIHx8IGNvdW50cnlDb2RlLmxlbmd0aCAhPT0gMikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLmNvdW50cnljb2RlKSk7XG4gICAgfSBlbHNlIGlmICghbXNpc2RuKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMubXNpc2RuKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBvcHRzID0ge1xuICAgICAgICBjb3VudHJ5OiBjb3VudHJ5Q29kZSxcbiAgICAgICAgbXNpc2RuLFxuICAgICAgICBhcGlfa2V5OiB0aGlzLmNyZWRzLmFwaUtleSxcbiAgICAgICAgYXBpX3NlY3JldDogdGhpcy5jcmVkcy5hcGlTZWNyZXRcbiAgICAgIH07XG5cbiAgICAgIGlmICh0YXJnZXRBcGlLZXkgaW5zdGFuY2VvZiBGdW5jdGlvbikge1xuICAgICAgICBjYWxsYmFjayA9IHRhcmdldEFwaUtleTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG9wdHMudGFyZ2V0X2FwaV9rZXkgPSB0YXJnZXRBcGlLZXk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS9idXlgLCBvcHRzKVxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBjYW5jZWwoY291bnRyeUNvZGUsIG1zaXNkbiwgdGFyZ2V0QXBpS2V5LCBjYWxsYmFjaykge1xuICAgIGlmICghY291bnRyeUNvZGUgfHwgY291bnRyeUNvZGUubGVuZ3RoICE9PSAyKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihOdW1iZXIuRVJST1JfTUVTU0FHRVMuY291bnRyeWNvZGUpKTtcbiAgICB9IGVsc2UgaWYgKCFtc2lzZG4pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5tc2lzZG4pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IG9wdHMgPSB7XG4gICAgICAgIGNvdW50cnk6IGNvdW50cnlDb2RlLFxuICAgICAgICBtc2lzZG4sXG4gICAgICAgIGFwaV9rZXk6IHRoaXMuY3JlZHMuYXBpS2V5LFxuICAgICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldFxuICAgICAgfTtcblxuICAgICAgaWYgKHRhcmdldEFwaUtleSBpbnN0YW5jZW9mIEZ1bmN0aW9uKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdGFyZ2V0QXBpS2V5O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgb3B0cy50YXJnZXRfYXBpX2tleSA9IHRhcmdldEFwaUtleTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIHBhdGg6IFV0aWxzLmNyZWF0ZVBhdGhXaXRoUXVlcnkoYCR7TnVtYmVyLlBBVEh9L2NhbmNlbGAsIG9wdHMpXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHVwZGF0ZShjb3VudHJ5Q29kZSwgbXNpc2RuLCBwYXJhbXMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCFjb3VudHJ5Q29kZSB8fCBjb3VudHJ5Q29kZS5sZW5ndGggIT09IDIpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE51bWJlci5FUlJPUl9NRVNTQUdFUy5jb3VudHJ5Y29kZSkpO1xuICAgIH0gZWxzZSBpZiAoIW1zaXNkbikge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTnVtYmVyLkVSUk9SX01FU1NBR0VTLm1zaXNkbikpO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXNbXCJjb3VudHJ5XCJdID0gY291bnRyeUNvZGU7XG4gICAgICBwYXJhbXNbXCJtc2lzZG5cIl0gPSBtc2lzZG47XG4gICAgICBwYXJhbXNbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICBwYXJhbXNbXCJhcGlfc2VjcmV0XCJdID0gdGhpcy5jcmVkcy5hcGlTZWNyZXQ7XG5cbiAgICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBwYXRoOiBVdGlscy5jcmVhdGVQYXRoV2l0aFF1ZXJ5KGAke051bWJlci5QQVRIfS91cGRhdGVgLCBwYXJhbXMpXG4gICAgICAgIH0sXG4gICAgICAgIFwiUE9TVFwiLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTnVtYmVyO1xuIl19