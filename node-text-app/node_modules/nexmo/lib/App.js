"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class App {
  /**
   * Provides access to the `applications` version 2 endpoint.
   */
  static get PATH() {
    return "/v2/applications";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition App options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }

  _convertMethodSignature(name, type, answerUrl, eventUrl, options) {
    var capability = {};

    switch (type) {
      case "voice":
        capability = {
          voice: {
            webhooks: {
              answer_url: {
                address: answerUrl,
                http_method: "GET"
              },
              event_url: {
                address: eventUrl,
                http_method: "POST"
              }
            }
          }
        };
        break;

      case "messages":
        capability = {
          messages: {
            webhooks: {
              inbound_url: {
                address: options.inbound_url,
                http_method: "POST"
              },
              status_url: {
                address: options.status_url,
                http_method: "POST"
              }
            }
          }
        };
        break;

      case "rtc":
        capability = {
          rtc: {
            webhooks: {
              event_url: {
                address: eventUrl,
                http_method: "POST"
              }
            }
          }
        };
        break;
    }

    return {
      name: name,
      capabilities: capability
    };
  }

  _convertApplicationResponse(application) {
    for (var capability in application.capabilities) {
      application[capability] = {
        webhooks: []
      };

      for (var webhook in application.capabilities[capability].webhooks) {
        application[capability].webhooks.push({
          endpoint_type: webhook,
          endpoint: application.capabilities[capability].webhooks[webhook].address,
          http_method: application.capabilities[capability].webhooks[webhook].http_method
        });
      }
    }

    delete application.capabilities;
    return application;
  }

  _convertApplicationListResponse(applicationResponseHandler) {
    return response => {
      response.count = response.total_items;
      response.page_index = response.page;

      for (var i in response._embedded.applications) {
        response._embedded.applications[i] = applicationResponseHandler(response._embedded.applications[i]);
      }

      return response;
    };
  }
  /**
   * TODO: document
   */


  create(name, type, answerUrl, eventUrl, options, callback) {
    var params = {};
    var responseParser = null;

    if (arguments.length > 2) {
      params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
      responseParser = this._convertApplicationResponse;
    } else {
      params = JSON.stringify(name);
      callback = type;
    }

    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: App.PATH,
      method: "POST",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  get(params, callback) {
    var v2 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var responseParser = null;

    if (typeof params !== "object") {
      responseParser = this._convertApplicationResponse;
    } else {
      responseParser = this._convertApplicationListResponse(this._convertApplicationResponse);
    }

    if (v2) {
      responseParser = null;
    }

    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: _Utils.default.createPathWithQuery(App.PATH, params),
      method: "GET",
      body: undefined,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  update(appId, name, type, answerUrl, eventUrl, options, callback) {
    var params = {};
    var responseParser = null;

    if (arguments.length > 3) {
      params = JSON.stringify(this._convertMethodSignature(name, type, answerUrl, eventUrl, options));
      responseParser = this._convertApplicationResponse;
    } else {
      params = JSON.stringify(name);
      callback = type;
    }

    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(App.PATH, "/").concat(appId),
      method: "PUT",
      body: params,
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback, callback, false, responseParser);
  }
  /**
   * TODO: document
   */


  delete(appId, callback) {
    var authorization = "".concat(this.creds.apiKey, ":").concat(this.creds.apiSecret);
    var config = {
      host: this.options.apiHost || "api.nexmo.com",
      path: "".concat(App.PATH, "/").concat(appId),
      method: "DELETE",
      body: "{}",
      headers: {
        "Content-Type": "application/json",
        Authorization: "Basic ".concat(Buffer.from(authorization).toString("base64"))
      }
    };
    this.options.httpClient.request(config, callback);
  }

}

var _default = App;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9BcHAuanMiXSwibmFtZXMiOlsiQXBwIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfY29udmVydE1ldGhvZFNpZ25hdHVyZSIsIm5hbWUiLCJ0eXBlIiwiYW5zd2VyVXJsIiwiZXZlbnRVcmwiLCJjYXBhYmlsaXR5Iiwidm9pY2UiLCJ3ZWJob29rcyIsImFuc3dlcl91cmwiLCJhZGRyZXNzIiwiaHR0cF9tZXRob2QiLCJldmVudF91cmwiLCJtZXNzYWdlcyIsImluYm91bmRfdXJsIiwic3RhdHVzX3VybCIsInJ0YyIsImNhcGFiaWxpdGllcyIsIl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZSIsImFwcGxpY2F0aW9uIiwid2ViaG9vayIsInB1c2giLCJlbmRwb2ludF90eXBlIiwiZW5kcG9pbnQiLCJfY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlIiwiYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIiLCJyZXNwb25zZSIsImNvdW50IiwidG90YWxfaXRlbXMiLCJwYWdlX2luZGV4IiwicGFnZSIsImkiLCJfZW1iZWRkZWQiLCJhcHBsaWNhdGlvbnMiLCJjcmVhdGUiLCJjYWxsYmFjayIsInBhcmFtcyIsInJlc3BvbnNlUGFyc2VyIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiSlNPTiIsInN0cmluZ2lmeSIsImF1dGhvcml6YXRpb24iLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJjb25maWciLCJob3N0IiwiYXBpSG9zdCIsInBhdGgiLCJtZXRob2QiLCJib2R5IiwiaGVhZGVycyIsIkF1dGhvcml6YXRpb24iLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsImdldCIsInYyIiwiVXRpbHMiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwidW5kZWZpbmVkIiwidXBkYXRlIiwiYXBwSWQiLCJkZWxldGUiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7O0FB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TUFBTSxDQUFDQyxJQUFQLENBQVlaLGFBQVosRUFBMkJhLFFBQTNCLENBQW9DLFFBQXBDLENBQVg7QUFGTjtBQUxFLEtBQWI7QUFXQSxTQUFLeEQsT0FBTCxDQUFheUQsVUFBYixDQUF3QkMsT0FBeEIsQ0FBZ0NaLE1BQWhDLEVBQXdDVixRQUF4QztBQUNEOztBQWpQTzs7ZUFvUEt4QyxHIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBVdGlscyBmcm9tIFwiLi9VdGlsc1wiO1xuXG5jbGFzcyBBcHAge1xuICAvKipcbiAgICogUHJvdmlkZXMgYWNjZXNzIHRvIHRoZSBgYXBwbGljYXRpb25zYCB2ZXJzaW9uIDIgZW5kcG9pbnQuXG4gICAqL1xuICBzdGF0aWMgZ2V0IFBBVEgoKSB7XG4gICAgcmV0dXJuIFwiL3YyL2FwcGxpY2F0aW9uc1wiO1xuICB9XG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBBcHAgb3B0aW9ucy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNyZWRzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgfVxuXG4gIF9jb252ZXJ0TWV0aG9kU2lnbmF0dXJlKG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMpIHtcbiAgICBsZXQgY2FwYWJpbGl0eSA9IHt9O1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcInZvaWNlXCI6XG4gICAgICAgIGNhcGFiaWxpdHkgPSB7XG4gICAgICAgICAgdm9pY2U6IHtcbiAgICAgICAgICAgIHdlYmhvb2tzOiB7XG4gICAgICAgICAgICAgIGFuc3dlcl91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBhbnN3ZXJVcmwsXG4gICAgICAgICAgICAgICAgaHR0cF9tZXRob2Q6IFwiR0VUXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgZXZlbnRfdXJsOiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzczogZXZlbnRVcmwsXG4gICAgICAgICAgICAgICAgaHR0cF9tZXRob2Q6IFwiUE9TVFwiXG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIm1lc3NhZ2VzXCI6XG4gICAgICAgIGNhcGFiaWxpdHkgPSB7XG4gICAgICAgICAgbWVzc2FnZXM6IHtcbiAgICAgICAgICAgIHdlYmhvb2tzOiB7XG4gICAgICAgICAgICAgIGluYm91bmRfdXJsOiB7XG4gICAgICAgICAgICAgICAgYWRkcmVzczogb3B0aW9ucy5pbmJvdW5kX3VybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgc3RhdHVzX3VybDoge1xuICAgICAgICAgICAgICAgIGFkZHJlc3M6IG9wdGlvbnMuc3RhdHVzX3VybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwicnRjXCI6XG4gICAgICAgIGNhcGFiaWxpdHkgPSB7XG4gICAgICAgICAgcnRjOiB7XG4gICAgICAgICAgICB3ZWJob29rczoge1xuICAgICAgICAgICAgICBldmVudF91cmw6IHtcbiAgICAgICAgICAgICAgICBhZGRyZXNzOiBldmVudFVybCxcbiAgICAgICAgICAgICAgICBodHRwX21ldGhvZDogXCJQT1NUXCJcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIG5hbWU6IG5hbWUsXG4gICAgICBjYXBhYmlsaXRpZXM6IGNhcGFiaWxpdHlcbiAgICB9O1xuICB9XG5cbiAgX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlKGFwcGxpY2F0aW9uKSB7XG4gICAgZm9yIChsZXQgY2FwYWJpbGl0eSBpbiBhcHBsaWNhdGlvbi5jYXBhYmlsaXRpZXMpIHtcbiAgICAgIGFwcGxpY2F0aW9uW2NhcGFiaWxpdHldID0ge1xuICAgICAgICB3ZWJob29rczogW11cbiAgICAgIH07XG4gICAgICBmb3IgKGxldCB3ZWJob29rIGluIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllc1tjYXBhYmlsaXR5XS53ZWJob29rcykge1xuICAgICAgICBhcHBsaWNhdGlvbltjYXBhYmlsaXR5XS53ZWJob29rcy5wdXNoKHtcbiAgICAgICAgICBlbmRwb2ludF90eXBlOiB3ZWJob29rLFxuICAgICAgICAgIGVuZHBvaW50OlxuICAgICAgICAgICAgYXBwbGljYXRpb24uY2FwYWJpbGl0aWVzW2NhcGFiaWxpdHldLndlYmhvb2tzW3dlYmhvb2tdLmFkZHJlc3MsXG4gICAgICAgICAgaHR0cF9tZXRob2Q6XG4gICAgICAgICAgICBhcHBsaWNhdGlvbi5jYXBhYmlsaXRpZXNbY2FwYWJpbGl0eV0ud2ViaG9va3Nbd2ViaG9va10uaHR0cF9tZXRob2RcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZGVsZXRlIGFwcGxpY2F0aW9uLmNhcGFiaWxpdGllcztcbiAgICByZXR1cm4gYXBwbGljYXRpb247XG4gIH1cblxuICBfY29udmVydEFwcGxpY2F0aW9uTGlzdFJlc3BvbnNlKGFwcGxpY2F0aW9uUmVzcG9uc2VIYW5kbGVyKSB7XG4gICAgcmV0dXJuIHJlc3BvbnNlID0+IHtcbiAgICAgIHJlc3BvbnNlLmNvdW50ID0gcmVzcG9uc2UudG90YWxfaXRlbXM7XG4gICAgICByZXNwb25zZS5wYWdlX2luZGV4ID0gcmVzcG9uc2UucGFnZTtcbiAgICAgIGZvciAobGV0IGkgaW4gcmVzcG9uc2UuX2VtYmVkZGVkLmFwcGxpY2F0aW9ucykge1xuICAgICAgICByZXNwb25zZS5fZW1iZWRkZWQuYXBwbGljYXRpb25zW2ldID0gYXBwbGljYXRpb25SZXNwb25zZUhhbmRsZXIoXG4gICAgICAgICAgcmVzcG9uc2UuX2VtYmVkZGVkLmFwcGxpY2F0aW9uc1tpXVxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gcmVzcG9uc2U7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgY3JlYXRlKG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMsIGNhbGxiYWNrKSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGxldCByZXNwb25zZVBhcnNlciA9IG51bGw7XG5cbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDIpIHtcbiAgICAgIHBhcmFtcyA9IEpTT04uc3RyaW5naWZ5KFxuICAgICAgICB0aGlzLl9jb252ZXJ0TWV0aG9kU2lnbmF0dXJlKG5hbWUsIHR5cGUsIGFuc3dlclVybCwgZXZlbnRVcmwsIG9wdGlvbnMpXG4gICAgICApO1xuICAgICAgcmVzcG9uc2VQYXJzZXIgPSB0aGlzLl9jb252ZXJ0QXBwbGljYXRpb25SZXNwb25zZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkobmFtZSk7XG4gICAgICBjYWxsYmFjayA9IHR5cGU7XG4gICAgfVxuXG4gICAgY29uc3QgYXV0aG9yaXphdGlvbiA9IGAke3RoaXMuY3JlZHMuYXBpS2V5fToke3RoaXMuY3JlZHMuYXBpU2VjcmV0fWA7XG5cbiAgICB2YXIgY29uZmlnID0ge1xuICAgICAgaG9zdDogdGhpcy5vcHRpb25zLmFwaUhvc3QgfHwgXCJhcGkubmV4bW8uY29tXCIsXG4gICAgICBwYXRoOiBBcHAuUEFUSCxcbiAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICBib2R5OiBwYXJhbXMsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmFzaWMgJHtCdWZmZXIuZnJvbShhdXRob3JpemF0aW9uKS50b1N0cmluZyhcImJhc2U2NFwiKX1gXG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICBjb25maWcsXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgZmFsc2UsXG4gICAgICByZXNwb25zZVBhcnNlclxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIGdldChwYXJhbXMsIGNhbGxiYWNrLCB2MiA9IGZhbHNlKSB7XG4gICAgY29uc3QgYXV0aG9yaXphdGlvbiA9IGAke3RoaXMuY3JlZHMuYXBpS2V5fToke3RoaXMuY3JlZHMuYXBpU2VjcmV0fWA7XG4gICAgbGV0IHJlc3BvbnNlUGFyc2VyID0gbnVsbDtcblxuICAgIGlmICh0eXBlb2YgcGFyYW1zICE9PSBcIm9iamVjdFwiKSB7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvbkxpc3RSZXNwb25zZShcbiAgICAgICAgdGhpcy5fY29udmVydEFwcGxpY2F0aW9uUmVzcG9uc2VcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHYyKSB7XG4gICAgICByZXNwb25zZVBhcnNlciA9IG51bGw7XG4gICAgfVxuXG4gICAgdmFyIGNvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShBcHAuUEFUSCwgcGFyYW1zKSxcbiAgICAgIG1ldGhvZDogXCJHRVRcIixcbiAgICAgIGJvZHk6IHVuZGVmaW5lZCxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgXCJDb250ZW50LVR5cGVcIjogXCJhcHBsaWNhdGlvbi9qc29uXCIsXG4gICAgICAgIEF1dGhvcml6YXRpb246IGBCYXNpYyAke0J1ZmZlci5mcm9tKGF1dGhvcml6YXRpb24pLnRvU3RyaW5nKFwiYmFzZTY0XCIpfWBcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgIGNvbmZpZyxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgY2FsbGJhY2ssXG4gICAgICBmYWxzZSxcbiAgICAgIHJlc3BvbnNlUGFyc2VyXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgdXBkYXRlKGFwcElkLCBuYW1lLCB0eXBlLCBhbnN3ZXJVcmwsIGV2ZW50VXJsLCBvcHRpb25zLCBjYWxsYmFjaykge1xuICAgIGxldCBwYXJhbXMgPSB7fTtcbiAgICBsZXQgcmVzcG9uc2VQYXJzZXIgPSBudWxsO1xuICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID4gMykge1xuICAgICAgcGFyYW1zID0gSlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHRoaXMuX2NvbnZlcnRNZXRob2RTaWduYXR1cmUobmFtZSwgdHlwZSwgYW5zd2VyVXJsLCBldmVudFVybCwgb3B0aW9ucylcbiAgICAgICk7XG4gICAgICByZXNwb25zZVBhcnNlciA9IHRoaXMuX2NvbnZlcnRBcHBsaWNhdGlvblJlc3BvbnNlO1xuICAgIH0gZWxzZSB7XG4gICAgICBwYXJhbXMgPSBKU09OLnN0cmluZ2lmeShuYW1lKTtcbiAgICAgIGNhbGxiYWNrID0gdHlwZTtcbiAgICB9XG5cbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcblxuICAgIHZhciBjb25maWcgPSB7XG4gICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IGAke0FwcC5QQVRIfS8ke2FwcElkfWAsXG4gICAgICBtZXRob2Q6IFwiUFVUXCIsXG4gICAgICBib2R5OiBwYXJhbXMsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmFzaWMgJHtCdWZmZXIuZnJvbShhdXRob3JpemF0aW9uKS50b1N0cmluZyhcImJhc2U2NFwiKX1gXG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoXG4gICAgICBjb25maWcsXG4gICAgICBjYWxsYmFjayxcbiAgICAgIGNhbGxiYWNrLFxuICAgICAgZmFsc2UsXG4gICAgICByZXNwb25zZVBhcnNlclxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIGRlbGV0ZShhcHBJZCwgY2FsbGJhY2spIHtcbiAgICBjb25zdCBhdXRob3JpemF0aW9uID0gYCR7dGhpcy5jcmVkcy5hcGlLZXl9OiR7dGhpcy5jcmVkcy5hcGlTZWNyZXR9YDtcblxuICAgIHZhciBjb25maWcgPSB7XG4gICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgIHBhdGg6IGAke0FwcC5QQVRIfS8ke2FwcElkfWAsXG4gICAgICBtZXRob2Q6IFwiREVMRVRFXCIsXG4gICAgICBib2R5OiBcInt9XCIsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvblwiLFxuICAgICAgICBBdXRob3JpemF0aW9uOiBgQmFzaWMgJHtCdWZmZXIuZnJvbShhdXRob3JpemF0aW9uKS50b1N0cmluZyhcImJhc2U2NFwiKX1gXG4gICAgICB9XG4gICAgfTtcblxuICAgIHRoaXMub3B0aW9ucy5odHRwQ2xpZW50LnJlcXVlc3QoY29uZmlnLCBjYWxsYmFjayk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQXBwO1xuIl19