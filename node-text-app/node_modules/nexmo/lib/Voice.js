"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class Voice {
  static get ERROR_MESSAGES() {
    return {
      to: "Invalid to address",
      msg: "Invalid Text Message",
      maxDigits: "Invalid max digits for TTS prompt",
      byeText: "Invalid bye text for TTS prompt",
      pinCode: "Invalid pin code for TTS confirm",
      failedText: "Invalid failed text for TTS confirm",
      answerUrl: "Invalid answer URL for call"
    };
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition  options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;
  }

  _sendVoiceMessage(endpoint, data, callback) {
    if (!data.to) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.to));
    } else {
      data["api_key"] = this.creds.apiKey;
      data["api_secret"] = this.creds.apiSecret;
      this.options.logger.info("sending TTS message to " + data.to + " with message " + data.text);
      this.options.httpClient.request({
        host: endpoint.host,
        path: _Utils.default.createPathWithQuery(endpoint.path, data)
      }, "POST", (err, apiResponse) => {
        if (!err && apiResponse.status && apiResponse.status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendTTSMessage(recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithCapture(recipient, message, maxDigits, byeText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["bye_text"] = byeText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  sendTTSPromptWithConfirm(recipient, message, maxDigits, pinCode, byeText, failedText, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.msg));
    } else if (!maxDigits || isNaN(maxDigits) || maxDigits.length > 16) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.maxDigits));
    } else if (!pinCode || pinCode.length !== maxDigits) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.pinCode));
    } else if (!byeText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.byeText));
    } else if (!failedText) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.failedText));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["text"] = message;
      opts["max_digits"] = maxDigits;
      opts["pin_code"] = pinCode;
      opts["bye_text"] = byeText;
      opts["failed_text"] = failedText;

      this._sendVoiceMessage({
        host: this.options.apiHost || "api.nexmo.com",
        path: "/tts-prompt/json"
      }, opts, callback);
    }
  }
  /**
   * TODO: remove with next major version, API is 404
   */


  call(recipient, answerUrl, opts, callback) {
    if (!answerUrl) {
      _Utils.default.sendError(callback, new Error(Voice.ERROR_MESSAGES.answerUrl));
    } else {
      if (!opts) {
        opts = {};
      }

      opts["to"] = recipient;
      opts["answer_url"] = answerUrl;

      this._sendVoiceMessage({
        host: this.options.restHost || "rest.nexmo.com",
        path: "/call/json"
      }, opts, callback);
    }
  }

}

var _default = Voice;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9Wb2ljZS5qcyJdLCJuYW1lcyI6WyJWb2ljZSIsIkVSUk9SX01FU1NBR0VTIiwidG8iLCJtc2ciLCJtYXhEaWdpdHMiLCJieWVUZXh0IiwicGluQ29kZSIsImZhaWxlZFRleHQiLCJhbnN3ZXJVcmwiLCJjb25zdHJ1Y3RvciIsImNyZWRlbnRpYWxzIiwib3B0aW9ucyIsImNyZWRzIiwiX3NlbmRWb2ljZU1lc3NhZ2UiLCJlbmRwb2ludCIsImRhdGEiLCJjYWxsYmFjayIsIlV0aWxzIiwic2VuZEVycm9yIiwiRXJyb3IiLCJhcGlLZXkiLCJhcGlTZWNyZXQiLCJsb2dnZXIiLCJpbmZvIiwidGV4dCIsImh0dHBDbGllbnQiLCJyZXF1ZXN0IiwiaG9zdCIsInBhdGgiLCJjcmVhdGVQYXRoV2l0aFF1ZXJ5IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJzZW5kVFRTTWVzc2FnZSIsInJlY2lwaWVudCIsIm1lc3NhZ2UiLCJvcHRzIiwiYXBpSG9zdCIsInNlbmRUVFNQcm9tcHRXaXRoQ2FwdHVyZSIsImlzTmFOIiwibGVuZ3RoIiwic2VuZFRUU1Byb21wdFdpdGhDb25maXJtIiwiY2FsbCIsInJlc3RIb3N0Il0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7OztBQUVBOzs7O0FBRUEsTUFBTUEsS0FBTixDQUFZO0FBQ1YsYUFBV0MsY0FBWCxHQUE0QjtBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLEVBQUUsRUFBRSxvQkFEQztBQUVMQyxNQUFBQSxHQUFHLEVBQUUsc0JBRkE7QUFHTEMsTUFBQUEsU0FBUyxFQUFFLG1DQUhOO0FBSUxDLE1BQUFBLE9BQU8sRUFBRSxpQ0FKSjtBQUtMQyxNQUFBQSxPQUFPLEVBQUUsa0NBTEo7QUFNTEMsTUFBQUEsVUFBVSxFQUFFLHFDQU5QO0FBT0xDLE1BQUFBLFNBQVMsRUFBRTtBQVBOLEtBQVA7QUFTRDtBQUNEOzs7Ozs7OztBQU1BQyxFQUFBQSxXQUFXLENBQUNDLFdBQUQsRUFBNEI7QUFBQSxRQUFkQyxPQUFjLHVF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QUFELENBQUosR0FBbUIvQixPQUFuQjtBQUNBK0IsTUFBQUEsSUFBSSxDQUFDLGFBQUQsQ0FBSixHQUFzQjdCLFVBQXRCOztBQUNBLFdBQUtNLGlCQUFMLENBQ0U7QUFDRWMsUUFBQUEsSUFBSSxFQUFFLEtBQUtoQixPQUFMLENBQWEwQixPQUFiLElBQXdCLGVBRGhDO0FBRUVULFFBQUFBLElBQUksRUFBRTtBQUZSLE9BREYsRUFLRVEsSUFMRixFQU1FcEIsUUFORjtBQVFEO0FBQ0Y7QUFFRDs7Ozs7QUFHQTBCLEVBQUFBLElBQUksQ0FBQ1IsU0FBRCxFQUFZMUIsU0FBWixFQUF1QjRCLElBQXZCLEVBQTZCcEIsUUFBN0IsRUFBdUM7QUFDekMsUUFBSSxDQUFDUixTQUFMLEVBQWdCO0FBQ2RTLHFCQUFNQyxTQUFOLENBQWdCRixRQUFoQixFQUEwQixJQUFJRyxLQUFKLENBQVVuQixLQUFLLENBQUNDLGNBQU4sQ0FBcUJPLFNBQS9CLENBQTFCO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsVUFBSSxDQUFDNEIsSUFBTCxFQUFXO0FBQ1RBLFFBQUFBLElBQUksR0FBRyxFQUFQO0FBQ0Q7O0FBQ0RBLE1BQUFBLElBQUksQ0FBQyxJQUFELENBQUosR0FBYUYsU0FBYjtBQUNBRSxNQUFBQSxJQUFJLENBQUMsWUFBRCxDQUFKLEdBQXFCNUIsU0FBckI7O0FBQ0EsV0FBS0ssaUJBQUwsQ0FDRTtBQUNFYyxRQUFBQSxJQUFJLEVBQUUsS0FBS2hCLE9BQUwsQ0FBYWdDLFFBQWIsSUFBeUIsZ0JBRGpDO0FBRUVmLFFBQUFBLElBQUksRUFBRTtBQUZSLE9BREYsRUFLRVEsSUFMRixFQU1FcEIsUUFORjtBQVFEO0FBQ0Y7O0FBakxTOztlQW9MR2hCLEsiLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IFV0aWxzIGZyb20gXCIuL1V0aWxzXCI7XG5cbmNsYXNzIFZvaWNlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgdG86IFwiSW52YWxpZCB0byBhZGRyZXNzXCIsXG4gICAgICBtc2c6IFwiSW52YWxpZCBUZXh0IE1lc3NhZ2VcIixcbiAgICAgIG1heERpZ2l0czogXCJJbnZhbGlkIG1heCBkaWdpdHMgZm9yIFRUUyBwcm9tcHRcIixcbiAgICAgIGJ5ZVRleHQ6IFwiSW52YWxpZCBieWUgdGV4dCBmb3IgVFRTIHByb21wdFwiLFxuICAgICAgcGluQ29kZTogXCJJbnZhbGlkIHBpbiBjb2RlIGZvciBUVFMgY29uZmlybVwiLFxuICAgICAgZmFpbGVkVGV4dDogXCJJbnZhbGlkIGZhaWxlZCB0ZXh0IGZvciBUVFMgY29uZmlybVwiLFxuICAgICAgYW5zd2VyVXJsOiBcIkludmFsaWQgYW5zd2VyIFVSTCBmb3IgY2FsbFwiXG4gICAgfTtcbiAgfVxuICAvKipcbiAgICogQHBhcmFtIHtDcmVkZW50aWFsc30gY3JlZGVudGlhbHNcbiAgICogICAgY3JlZGVudGlhbHMgdG8gYmUgdXNlZCB3aGVuIGludGVyYWN0aW5nIHdpdGggdGhlIEFQSS5cbiAgICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnNcbiAgICogICAgQWRkaXRpb24gIG9wdGlvbnMuXG4gICAqL1xuICBjb25zdHJ1Y3RvcihjcmVkZW50aWFscywgb3B0aW9ucyA9IHt9KSB7XG4gICAgdGhpcy5jcmVkcyA9IGNyZWRlbnRpYWxzO1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gIH1cblxuICBfc2VuZFZvaWNlTWVzc2FnZShlbmRwb2ludCwgZGF0YSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIWRhdGEudG8pIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLnRvKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGRhdGFbXCJhcGlfa2V5XCJdID0gdGhpcy5jcmVkcy5hcGlLZXk7XG4gICAgICBkYXRhW1wiYXBpX3NlY3JldFwiXSA9IHRoaXMuY3JlZHMuYXBpU2VjcmV0O1xuICAgICAgdGhpcy5vcHRpb25zLmxvZ2dlci5pbmZvKFxuICAgICAgICBcInNlbmRpbmcgVFRTIG1lc3NhZ2UgdG8gXCIgKyBkYXRhLnRvICsgXCIgd2l0aCBtZXNzYWdlIFwiICsgZGF0YS50ZXh0XG4gICAgICApO1xuICAgICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IGVuZHBvaW50Lmhvc3QsXG4gICAgICAgICAgcGF0aDogVXRpbHMuY3JlYXRlUGF0aFdpdGhRdWVyeShlbmRwb2ludC5wYXRoLCBkYXRhKVxuICAgICAgICB9LFxuICAgICAgICBcIlBPU1RcIixcbiAgICAgICAgKGVyciwgYXBpUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICBpZiAoIWVyciAmJiBhcGlSZXNwb25zZS5zdGF0dXMgJiYgYXBpUmVzcG9uc2Uuc3RhdHVzID4gMCkge1xuICAgICAgICAgICAgVXRpbHMuc2VuZEVycm9yKFxuICAgICAgICAgICAgICBjYWxsYmFjayxcbiAgICAgICAgICAgICAgbmV3IEVycm9yKGFwaVJlc3BvbnNlW1wiZXJyb3ItdGV4dFwiXSksXG4gICAgICAgICAgICAgIGFwaVJlc3BvbnNlXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAoY2FsbGJhY2spIGNhbGxiYWNrKGVyciwgYXBpUmVzcG9uc2UpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRUVFNNZXNzYWdlKHJlY2lwaWVudCwgbWVzc2FnZSwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIW1lc3NhZ2UpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1zZykpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoIW9wdHMpIHtcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgdGhpcy5fc2VuZFZvaWNlTWVzc2FnZShcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5hcGlIb3N0IHx8IFwiYXBpLm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IFwiL3R0cy9qc29uXCJcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IHJlbW92ZSB3aXRoIG5leHQgbWFqb3IgdmVyc2lvbiwgQVBJIGlzIDQwNFxuICAgKi9cbiAgc2VuZFRUU1Byb21wdFdpdGhDYXB0dXJlKFxuICAgIHJlY2lwaWVudCxcbiAgICBtZXNzYWdlLFxuICAgIG1heERpZ2l0cyxcbiAgICBieWVUZXh0LFxuICAgIG9wdHMsXG4gICAgY2FsbGJhY2tcbiAgKSB7XG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2UgaWYgKCFtYXhEaWdpdHMgfHwgaXNOYU4obWF4RGlnaXRzKSB8fCBtYXhEaWdpdHMubGVuZ3RoID4gMTYpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1heERpZ2l0cykpO1xuICAgIH0gZWxzZSBpZiAoIWJ5ZVRleHQpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmJ5ZVRleHQpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFvcHRzKSB7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJ0ZXh0XCJdID0gbWVzc2FnZTtcbiAgICAgIG9wdHNbXCJtYXhfZGlnaXRzXCJdID0gbWF4RGlnaXRzO1xuICAgICAgb3B0c1tcImJ5ZV90ZXh0XCJdID0gYnllVGV4dDtcbiAgICAgIHRoaXMuX3NlbmRWb2ljZU1lc3NhZ2UoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi90dHMtcHJvbXB0L2pzb25cIlxuICAgICAgICB9LFxuICAgICAgICBvcHRzLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciB2ZXJzaW9uLCBBUEkgaXMgNDA0XG4gICAqL1xuICBzZW5kVFRTUHJvbXB0V2l0aENvbmZpcm0oXG4gICAgcmVjaXBpZW50LFxuICAgIG1lc3NhZ2UsXG4gICAgbWF4RGlnaXRzLFxuICAgIHBpbkNvZGUsXG4gICAgYnllVGV4dCxcbiAgICBmYWlsZWRUZXh0LFxuICAgIG9wdHMsXG4gICAgY2FsbGJhY2tcbiAgKSB7XG4gICAgaWYgKCFtZXNzYWdlKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2UgaWYgKCFtYXhEaWdpdHMgfHwgaXNOYU4obWF4RGlnaXRzKSB8fCBtYXhEaWdpdHMubGVuZ3RoID4gMTYpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLm1heERpZ2l0cykpO1xuICAgIH0gZWxzZSBpZiAoIXBpbkNvZGUgfHwgcGluQ29kZS5sZW5ndGggIT09IG1heERpZ2l0cykge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoVm9pY2UuRVJST1JfTUVTU0FHRVMucGluQ29kZSkpO1xuICAgIH0gZWxzZSBpZiAoIWJ5ZVRleHQpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKFZvaWNlLkVSUk9SX01FU1NBR0VTLmJ5ZVRleHQpKTtcbiAgICB9IGVsc2UgaWYgKCFmYWlsZWRUZXh0KSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5mYWlsZWRUZXh0KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghb3B0cykge1xuICAgICAgICBvcHRzID0ge307XG4gICAgICB9XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widGV4dFwiXSA9IG1lc3NhZ2U7XG4gICAgICBvcHRzW1wibWF4X2RpZ2l0c1wiXSA9IG1heERpZ2l0cztcbiAgICAgIG9wdHNbXCJwaW5fY29kZVwiXSA9IHBpbkNvZGU7XG4gICAgICBvcHRzW1wiYnllX3RleHRcIl0gPSBieWVUZXh0O1xuICAgICAgb3B0c1tcImZhaWxlZF90ZXh0XCJdID0gZmFpbGVkVGV4dDtcbiAgICAgIHRoaXMuX3NlbmRWb2ljZU1lc3NhZ2UoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMuYXBpSG9zdCB8fCBcImFwaS5uZXhtby5jb21cIixcbiAgICAgICAgICBwYXRoOiBcIi90dHMtcHJvbXB0L2pzb25cIlxuICAgICAgICB9LFxuICAgICAgICBvcHRzLFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogcmVtb3ZlIHdpdGggbmV4dCBtYWpvciB2ZXJzaW9uLCBBUEkgaXMgNDA0XG4gICAqL1xuICBjYWxsKHJlY2lwaWVudCwgYW5zd2VyVXJsLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghYW5zd2VyVXJsKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihWb2ljZS5FUlJPUl9NRVNTQUdFUy5hbnN3ZXJVcmwpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFvcHRzKSB7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJ0b1wiXSA9IHJlY2lwaWVudDtcbiAgICAgIG9wdHNbXCJhbnN3ZXJfdXJsXCJdID0gYW5zd2VyVXJsO1xuICAgICAgdGhpcy5fc2VuZFZvaWNlTWVzc2FnZShcbiAgICAgICAge1xuICAgICAgICAgIGhvc3Q6IHRoaXMub3B0aW9ucy5yZXN0SG9zdCB8fCBcInJlc3QubmV4bW8uY29tXCIsXG4gICAgICAgICAgcGF0aDogXCIvY2FsbC9qc29uXCJcbiAgICAgICAgfSxcbiAgICAgICAgb3B0cyxcbiAgICAgICAgY2FsbGJhY2tcbiAgICAgICk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFZvaWNlO1xuIl19