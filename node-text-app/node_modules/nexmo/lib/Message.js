"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _Utils = _interopRequireDefault(require("./Utils"));

var _ShortCode = _interopRequireDefault(require("./ShortCode"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var querystring = require("querystring");

class Message {
  static get ERROR_MESSAGES() {
    return {
      sender: "Invalid from address",
      to: "Invalid to address",
      msg: "Invalid Text Message",
      body: "Invalid Body value in Binary Message",
      udh: "Invalid udh value in Binary Message",
      title: "Invalid title in WAP Push message",
      url: "Invalid url in WAP Push message"
    };
  }

  static get PATH() {
    return "/sms/json";
  }
  /**
   * @param {Credentials} credentials
   *    credentials to be used when interacting with the API.
   * @param {Object} options
   *    Addition SMS options.
   */


  constructor(credentials) {
    var options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};
    this.creds = credentials;
    this.options = options;

    var _shortcode = new _ShortCode.default(this.creds, this.options);

    this.shortcodeAlert = _shortcode.shortcodeAlert.bind(_shortcode);
    this.shortcode2FA = _shortcode.shortcode2FA.bind(_shortcode);
    this.shortcodeMarketing = _shortcode.shortcodeMarketing.bind(_shortcode);
  }

  _sendRequest(endpoint, method, callback) {
    endpoint.path = endpoint.path + (endpoint.path.indexOf("?") > 0 ? "&" : "?") + querystring.stringify({
      api_key: this.creds.apiKey,
      api_secret: this.creds.apiSecret
    });
    this.options.httpClient.request(endpoint, method, callback);
  }

  _sendMessage(data, callback) {
    if (!data.from) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.sender));
    } else if (!data.to) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.to));
    } else {
      var path = Message.PATH + "?" + querystring.stringify(data);
      this.options.logger.info("sending message from " + data.from + " to " + data.to + " with message " + data.text);

      this._sendRequest({
        host: this.options.restHost || "rest.nexmo.com",
        path: path
      }, "POST", function (err, apiResponse) {
        if (!err && apiResponse.status && apiResponse.messages[0].status > 0) {
          _Utils.default.sendError(callback, new Error(apiResponse.messages[0]["error-text"]), apiResponse);
        } else {
          if (callback) callback(err, apiResponse);
        }
      });
    }
  }
  /**
   * TODO: document
   */


  sendSms(sender, recipient, message, opts, callback) {
    if (!message) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.msg));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["text"] = message;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendBinaryMessage(sender, recipient, body, udh, opts, callback) {
    if (!body) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.body));
    } else if (!udh) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.udh));
    } else {
      if (!callback) {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "binary";
      opts["body"] = body;
      opts["udh"] = udh;

      this._sendMessage(opts, callback);
    }
  }
  /**
   * TODO: document
   */


  sendWapPushMessage(sender, recipient, title, url, validity, opts, callback) {
    if (!title) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.title));
    } else if (!url) {
      _Utils.default.sendError(callback, new Error(Message.ERROR_MESSAGES.url));
    } else {
      if (typeof validity === "function") {
        callback = validity;
        opts = {};
        validity = 86400000;
      }

      if (typeof opts === "function") {
        callback = opts;
        opts = {};
      }

      opts["from"] = sender;
      opts["to"] = recipient;
      opts["type"] = "wappush";
      opts["title"] = title;
      opts["validity"] = validity;
      opts["url"] = url;

      this._sendMessage(opts, callback);
    }
  }

  search(id, callback) {
    if (typeof id == "string") {
      return this.options.rest.get("/search/message", {
        id: id
      }, callback);
    } // Otherwise we expect an array


    return this.options.rest.get("/search/messages", {
      ids: id
    }, callback);
  }

  searchRejections(to, date, callback) {
    return this.options.rest.get("/search/rejections", {
      to,
      date
    }, callback);
  }

}

var _default = Message;
exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9NZXNzYWdlLmpzIl0sIm5hbWVzIjpbInF1ZXJ5c3RyaW5nIiwicmVxdWlyZSIsIk1lc3NhZ2UiLCJFUlJPUl9NRVNTQUdFUyIsInNlbmRlciIsInRvIiwibXNnIiwiYm9keSIsInVkaCIsInRpdGxlIiwidXJsIiwiUEFUSCIsImNvbnN0cnVjdG9yIiwiY3JlZGVudGlhbHMiLCJvcHRpb25zIiwiY3JlZHMiLCJfc2hvcnRjb2RlIiwiU2hvcnRDb2RlIiwic2hvcnRjb2RlQWxlcnQiLCJiaW5kIiwic2hvcnRjb2RlMkZBIiwic2hvcnRjb2RlTWFya2V0aW5nIiwiX3NlbmRSZXF1ZXN0IiwiZW5kcG9pbnQiLCJtZXRob2QiLCJjYWxsYmFjayIsInBhdGgiLCJpbmRleE9mIiwic3RyaW5naWZ5IiwiYXBpX2tleSIsImFwaUtleSIsImFwaV9zZWNyZXQiLCJhcGlTZWNyZXQiLCJodHRwQ2xpZW50IiwicmVxdWVzdCIsIl9zZW5kTWVzc2FnZSIsImRhdGEiLCJmcm9tIiwiVXRpbHMiLCJzZW5kRXJyb3IiLCJFcnJvciIsImxvZ2dlciIsImluZm8iLCJ0ZXh0IiwiaG9zdCIsInJlc3RIb3N0IiwiZXJyIiwiYXBpUmVzcG9uc2UiLCJzdGF0dXMiLCJtZXNzYWdlcyIsInNlbmRTbXMiLCJyZWNpcGllbnQiLCJtZXNzYWdlIiwib3B0cyIsInNlbmRCaW5hcnlNZXNzYWdlIiwic2VuZFdhcFB1c2hNZXNzYWdlIiwidmFsaWRpdHkiLCJzZWFyY2giLCJpZCIsInJlc3QiLCJnZXQiLCJpZHMiLCJzZWFyY2hSZWplY3Rpb25zIiwiZGF0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7QUFFQTs7QUFFQTs7OztBQUVBLElBQUlBLFdBQVcsR0FBR0MsT0FBTyxDQUFDLGFBQUQsQ0FBekI7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0FBQ1osYUFBV0MsY0FBWCxHQUE0QjtBQUMxQixXQUFPO0FBQ0xDLE1BQUFBLE1BQU0sRUFBRSxzQkFESDtBQUVMQyxNQUFBQSxFQUFF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S1gsT0FBTCxDQUFhNkMsSUFBYixDQUFrQkMsR0FBbEIsQ0FDTCxrQkFESyxFQUVMO0FBQ0VDLE1BQUFBLEdBQUcsRUFBRUg7QUFEUCxLQUZLLEVBS0xqQyxRQUxLLENBQVA7QUFPRDs7QUFFRHFDLEVBQUFBLGdCQUFnQixDQUFDekQsRUFBRCxFQUFLMEQsSUFBTCxFQUFXdEMsUUFBWCxFQUFxQjtBQUNuQyxXQUFPLEtBQUtYLE9BQUwsQ0FBYTZDLElBQWIsQ0FBa0JDLEdBQWxCLENBQ0wsb0JBREssRUFFTDtBQUNFdkQsTUFBQUEsRUFERjtBQUVFMEQsTUFBQUE7QUFGRixLQUZLLEVBTUx0QyxRQU5LLENBQVA7QUFRRDs7QUF2TFc7O2VBMExDdkIsTyIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQgVXRpbHMgZnJvbSBcIi4vVXRpbHNcIjtcblxuaW1wb3J0IFNob3J0Q29kZSBmcm9tIFwiLi9TaG9ydENvZGVcIjtcblxudmFyIHF1ZXJ5c3RyaW5nID0gcmVxdWlyZShcInF1ZXJ5c3RyaW5nXCIpO1xuXG5jbGFzcyBNZXNzYWdlIHtcbiAgc3RhdGljIGdldCBFUlJPUl9NRVNTQUdFUygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2VuZGVyOiBcIkludmFsaWQgZnJvbSBhZGRyZXNzXCIsXG4gICAgICB0bzogXCJJbnZhbGlkIHRvIGFkZHJlc3NcIixcbiAgICAgIG1zZzogXCJJbnZhbGlkIFRleHQgTWVzc2FnZVwiLFxuICAgICAgYm9keTogXCJJbnZhbGlkIEJvZHkgdmFsdWUgaW4gQmluYXJ5IE1lc3NhZ2VcIixcbiAgICAgIHVkaDogXCJJbnZhbGlkIHVkaCB2YWx1ZSBpbiBCaW5hcnkgTWVzc2FnZVwiLFxuICAgICAgdGl0bGU6IFwiSW52YWxpZCB0aXRsZSBpbiBXQVAgUHVzaCBtZXNzYWdlXCIsXG4gICAgICB1cmw6IFwiSW52YWxpZCB1cmwgaW4gV0FQIFB1c2ggbWVzc2FnZVwiXG4gICAgfTtcbiAgfVxuXG4gIHN0YXRpYyBnZXQgUEFUSCgpIHtcbiAgICByZXR1cm4gXCIvc21zL2pzb25cIjtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge0NyZWRlbnRpYWxzfSBjcmVkZW50aWFsc1xuICAgKiAgICBjcmVkZW50aWFscyB0byBiZSB1c2VkIHdoZW4gaW50ZXJhY3Rpbmcgd2l0aCB0aGUgQVBJLlxuICAgKiBAcGFyYW0ge09iamVjdH0gb3B0aW9uc1xuICAgKiAgICBBZGRpdGlvbiBTTVMgb3B0aW9ucy5cbiAgICovXG4gIGNvbnN0cnVjdG9yKGNyZWRlbnRpYWxzLCBvcHRpb25zID0ge30pIHtcbiAgICB0aGlzLmNyZWRzID0gY3JlZGVudGlhbHM7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcblxuICAgIHZhciBfc2hvcnRjb2RlID0gbmV3IFNob3J0Q29kZSh0aGlzLmNyZWRzLCB0aGlzLm9wdGlvbnMpO1xuXG4gICAgdGhpcy5zaG9ydGNvZGVBbGVydCA9IF9zaG9ydGNvZGUuc2hvcnRjb2RlQWxlcnQuYmluZChfc2hvcnRjb2RlKTtcbiAgICB0aGlzLnNob3J0Y29kZTJGQSA9IF9zaG9ydGNvZGUuc2hvcnRjb2RlMkZBLmJpbmQoX3Nob3J0Y29kZSk7XG4gICAgdGhpcy5zaG9ydGNvZGVNYXJrZXRpbmcgPSBfc2hvcnRjb2RlLnNob3J0Y29kZU1hcmtldGluZy5iaW5kKF9zaG9ydGNvZGUpO1xuICB9XG5cbiAgX3NlbmRSZXF1ZXN0KGVuZHBvaW50LCBtZXRob2QsIGNhbGxiYWNrKSB7XG4gICAgZW5kcG9pbnQucGF0aCA9XG4gICAgICBlbmRwb2ludC5wYXRoICtcbiAgICAgIChlbmRwb2ludC5wYXRoLmluZGV4T2YoXCI/XCIpID4gMCA/IFwiJlwiIDogXCI/XCIpICtcbiAgICAgIHF1ZXJ5c3RyaW5nLnN0cmluZ2lmeSh7XG4gICAgICAgIGFwaV9rZXk6IHRoaXMuY3JlZHMuYXBpS2V5LFxuICAgICAgICBhcGlfc2VjcmV0OiB0aGlzLmNyZWRzLmFwaVNlY3JldFxuICAgICAgfSk7XG4gICAgdGhpcy5vcHRpb25zLmh0dHBDbGllbnQucmVxdWVzdChlbmRwb2ludCwgbWV0aG9kLCBjYWxsYmFjayk7XG4gIH1cblxuICBfc2VuZE1lc3NhZ2UoZGF0YSwgY2FsbGJhY2spIHtcbiAgICBpZiAoIWRhdGEuZnJvbSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5zZW5kZXIpKTtcbiAgICB9IGVsc2UgaWYgKCFkYXRhLnRvKSB7XG4gICAgICBVdGlscy5zZW5kRXJyb3IoY2FsbGJhY2ssIG5ldyBFcnJvcihNZXNzYWdlLkVSUk9SX01FU1NBR0VTLnRvKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBwYXRoID0gTWVzc2FnZS5QQVRIICsgXCI/XCIgKyBxdWVyeXN0cmluZy5zdHJpbmdpZnkoZGF0YSk7XG4gICAgICB0aGlzLm9wdGlvbnMubG9nZ2VyLmluZm8oXG4gICAgICAgIFwic2VuZGluZyBtZXNzYWdlIGZyb20gXCIgK1xuICAgICAgICAgIGRhdGEuZnJvbSArXG4gICAgICAgICAgXCIgdG8gXCIgK1xuICAgICAgICAgIGRhdGEudG8gK1xuICAgICAgICAgIFwiIHdpdGggbWVzc2FnZSBcIiArXG4gICAgICAgICAgZGF0YS50ZXh0XG4gICAgICApO1xuICAgICAgdGhpcy5fc2VuZFJlcXVlc3QoXG4gICAgICAgIHtcbiAgICAgICAgICBob3N0OiB0aGlzLm9wdGlvbnMucmVzdEhvc3QgfHwgXCJyZXN0Lm5leG1vLmNvbVwiLFxuICAgICAgICAgIHBhdGg6IHBhdGhcbiAgICAgICAgfSxcbiAgICAgICAgXCJQT1NUXCIsXG4gICAgICAgIGZ1bmN0aW9uKGVyciwgYXBpUmVzcG9uc2UpIHtcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAhZXJyICYmXG4gICAgICAgICAgICBhcGlSZXNwb25zZS5zdGF0dXMgJiZcbiAgICAgICAgICAgIGFwaVJlc3BvbnNlLm1lc3NhZ2VzWzBdLnN0YXR1cyA+IDBcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIFV0aWxzLnNlbmRFcnJvcihcbiAgICAgICAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgICAgICAgIG5ldyBFcnJvcihhcGlSZXNwb25zZS5tZXNzYWdlc1swXVtcImVycm9yLXRleHRcIl0pLFxuICAgICAgICAgICAgICBhcGlSZXNwb25zZVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSBjYWxsYmFjayhlcnIsIGFwaVJlc3BvbnNlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRPRE86IGRvY3VtZW50XG4gICAqL1xuICBzZW5kU21zKHNlbmRlciwgcmVjaXBpZW50LCBtZXNzYWdlLCBvcHRzLCBjYWxsYmFjaykge1xuICAgIGlmICghbWVzc2FnZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy5tc2cpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInRleHRcIl0gPSBtZXNzYWdlO1xuICAgICAgdGhpcy5fc2VuZE1lc3NhZ2Uob3B0cywgY2FsbGJhY2spO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBUT0RPOiBkb2N1bWVudFxuICAgKi9cbiAgc2VuZEJpbmFyeU1lc3NhZ2Uoc2VuZGVyLCByZWNpcGllbnQsIGJvZHksIHVkaCwgb3B0cywgY2FsbGJhY2spIHtcbiAgICBpZiAoIWJvZHkpIHtcbiAgICAgIFV0aWxzLnNlbmRFcnJvcihjYWxsYmFjaywgbmV3IEVycm9yKE1lc3NhZ2UuRVJST1JfTUVTU0FHRVMuYm9keSkpO1xuICAgIH0gZWxzZSBpZiAoIXVkaCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51ZGgpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjYWxsYmFjaykge1xuICAgICAgICBjYWxsYmFjayA9IG9wdHM7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgIH1cbiAgICAgIG9wdHNbXCJmcm9tXCJdID0gc2VuZGVyO1xuICAgICAgb3B0c1tcInRvXCJdID0gcmVjaXBpZW50O1xuICAgICAgb3B0c1tcInR5cGVcIl0gPSBcImJpbmFyeVwiO1xuICAgICAgb3B0c1tcImJvZHlcIl0gPSBib2R5O1xuICAgICAgb3B0c1tcInVkaFwiXSA9IHVkaDtcbiAgICAgIHRoaXMuX3NlbmRNZXNzYWdlKG9wdHMsIGNhbGxiYWNrKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVE9ETzogZG9jdW1lbnRcbiAgICovXG4gIHNlbmRXYXBQdXNoTWVzc2FnZShzZW5kZXIsIHJlY2lwaWVudCwgdGl0bGUsIHVybCwgdmFsaWRpdHksIG9wdHMsIGNhbGxiYWNrKSB7XG4gICAgaWYgKCF0aXRsZSkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy50aXRsZSkpO1xuICAgIH0gZWxzZSBpZiAoIXVybCkge1xuICAgICAgVXRpbHMuc2VuZEVycm9yKGNhbGxiYWNrLCBuZXcgRXJyb3IoTWVzc2FnZS5FUlJPUl9NRVNTQUdFUy51cmwpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHR5cGVvZiB2YWxpZGl0eSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gdmFsaWRpdHk7XG4gICAgICAgIG9wdHMgPSB7fTtcbiAgICAgICAgdmFsaWRpdHkgPSA4NjQwMDAwMDtcbiAgICAgIH1cbiAgICAgIGlmICh0eXBlb2Ygb3B0cyA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgIGNhbGxiYWNrID0gb3B0cztcbiAgICAgICAgb3B0cyA9IHt9O1xuICAgICAgfVxuICAgICAgb3B0c1tcImZyb21cIl0gPSBzZW5kZXI7XG4gICAgICBvcHRzW1widG9cIl0gPSByZWNpcGllbnQ7XG4gICAgICBvcHRzW1widHlwZVwiXSA9IFwid2FwcHVzaFwiO1xuICAgICAgb3B0c1tcInRpdGxlXCJdID0gdGl0bGU7XG4gICAgICBvcHRzW1widmFsaWRpdHlcIl0gPSB2YWxpZGl0eTtcbiAgICAgIG9wdHNbXCJ1cmxcIl0gPSB1cmw7XG4gICAgICB0aGlzLl9zZW5kTWVzc2FnZShvcHRzLCBjYWxsYmFjayk7XG4gICAgfVxuICB9XG5cbiAgc2VhcmNoKGlkLCBjYWxsYmFjaykge1xuICAgIGlmICh0eXBlb2YgaWQgPT0gXCJzdHJpbmdcIikge1xuICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yZXN0LmdldChcbiAgICAgICAgXCIvc2VhcmNoL21lc3NhZ2VcIixcbiAgICAgICAge1xuICAgICAgICAgIGlkOiBpZFxuICAgICAgICB9LFxuICAgICAgICBjYWxsYmFja1xuICAgICAgKTtcbiAgICB9XG5cbiAgICAvLyBPdGhlcndpc2Ugd2UgZXhwZWN0IGFuIGFycmF5XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5yZXN0LmdldChcbiAgICAgIFwiL3NlYXJjaC9tZXNzYWdlc1wiLFxuICAgICAge1xuICAgICAgICBpZHM6IGlkXG4gICAgICB9LFxuICAgICAgY2FsbGJhY2tcbiAgICApO1xuICB9XG5cbiAgc2VhcmNoUmVqZWN0aW9ucyh0bywgZGF0ZSwgY2FsbGJhY2spIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLnJlc3QuZ2V0KFxuICAgICAgXCIvc2VhcmNoL3JlamVjdGlvbnNcIixcbiAgICAgIHtcbiAgICAgICAgdG8sXG4gICAgICAgIGRhdGVcbiAgICAgIH0sXG4gICAgICBjYWxsYmFja1xuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgTWVzc2FnZTtcbiJdfQ==